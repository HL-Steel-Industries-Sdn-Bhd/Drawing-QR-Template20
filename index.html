<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drawing + Work Entry Demo</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<!-- æ–°å¢jsQRåº“ç”¨äºæ›´å¥½çš„QRç è¯†åˆ« -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<style>
    * { box-sizing: border-box; margin:0; padding:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; }
    .container { background:white; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.2); width:100%; max-width:1400px; padding:30px; margin: 0 auto; }
    h2 { color:#333; text-align:center; margin-bottom:30px; font-size:28px; font-weight:600; }
    
    /* ===== é‡æ–°è®¾è®¡çš„ç¬¬ä¸€é¡µå¸ƒå±€ ===== */
    .drawing-content {
        display: flex;
        flex-direction: column;
    }
    
    @media (min-width: 768px) {
        .drawing-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: stretch;
        }
        
        .drawing-info, .scan-section {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
    }
    
    /* å›¾çº¸ä¿¡æ¯å¡ç‰‡æ ·å¼ - é‡æ–°è®¾è®¡ */
    .drawing-card { 
        background:#f8f9fa; 
        border-radius:8px; 
        padding:25px; 
        border-left:4px solid #667eea; 
        box-shadow:0 5px 15px rgba(0,0,0,0.05);
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    /* æ–°çš„è¡¨å•ç½‘æ ¼å¸ƒå±€ */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 15px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group.full-width {
        grid-column: 1 / -1;
    }
    
    .form-label {
        font-weight: 500;
        color: #555;
        margin-bottom: 6px;
        font-size: 14px;
        display: flex;
        align-items: center;
    }
    
    .form-label:before {
        content: "â€¢";
        color: #667eea;
        margin-right: 6px;
        font-weight: bold;
    }
    
    .form-value {
        padding: 12px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 15px;
        color: #333;
        font-weight: 500;
        min-height: 44px;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s;
    }
    
    .form-value:hover {
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102,126,234,0.1);
    }
    
    /* æ–°å¢ï¼šå€’è®¡æ—¶/è¶…æ—¶æ¡†æ ·å¼ */
    .countdown-container {
        display: flex;
        flex-direction: column;
        gap: 5px;
        padding: 15px;
        border-radius: 8px;
        margin-top: 10px;
        border: 2px solid transparent;
    }
    
    .countdown-container.future {
        background: rgba(76, 175, 80, 0.1);
        border-color: #4CAF50;
    }
    
    .countdown-container.past {
        background: rgba(244, 67, 54, 0.1);
        border-color: #f44336;
    }
    
    .countdown-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 5px;
        text-align: center;
    }
    
    .countdown-label {
        font-size: 0.9rem;
        opacity: 0.9;
        text-align: center;
    }
    
    .countdown-negative {
        color: #f44336;
        animation: pulse 2s infinite;
    }
    
    .countdown-positive {
        color: #4CAF50;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    /* æ‰‹æœºç‰ˆ - å‡å°‘é—´è· */
    @media (max-width: 767px) {
        .drawing-card { 
            padding:15px; 
            margin-bottom:15px; 
        }
        
        .form-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        h2 {
            margin-bottom:20px;
            font-size:24px;
        }
        
        .container {
            padding:20px;
        }
        
        .countdown-value {
            font-size: 1.5rem;
        }
    }
    
    /* æ‰«æåŒºåŸŸæ ·å¼ - é‡æ–°è®¾è®¡ */
    .scan-section {
        background:#f8f9fa; 
        border-radius:8px; 
        padding:25px; 
        text-align:center;
        border-left:4px solid #667eea;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .scan-instruction { 
        font-size:18px; 
        color:#667eea; 
        font-weight:600; 
        margin-bottom: 20px;
    }
    
    .scanner-container {
        width: 100%;
        height: 300px;
        border: 2px dashed #bbb;
        border-radius: 8px;
        position: relative;
        background-color: #f9f9f9;
        transition: all 0.3s ease;
        overflow: hidden;
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    @media (min-width: 768px) {
        .scanner-container {
            width: 300px;
            height: 300px;
            margin: 0 auto 20px;
        }
    }
    
    @media (max-width: 767px) {
        .scanner-container {
            height: 250px;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .scan-section {
            padding:15px;
            margin-top: 15px;
        }
    }
    
    /* æ–°çš„æ‰«æå™¨æ ·å¼ */
    #scannerVideo {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    #scannerCanvas {
        display: none;
    }
    
    .scanner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.95);
        z-index: 2;
        flex-direction: column;
        padding: 20px;
        text-align: center;
    }
    
    .scanner-overlay.hidden {
        display: none;
    }
    
    .scanner-status {
        font-size: 14px;
        color: #666;
        margin-top: 15px;
        padding: 8px 15px;
        background: rgba(0,0,0,0.05);
        border-radius: 4px;
    }
    
    /* å·¥ä½œèµ„æ–™éƒ¨åˆ† */
    .work-section {
        display: none;
    }
    
    /* ç¬¬äºŒé¡µé¡¶éƒ¨å›ºå®šå¤´éƒ¨æ ·å¼ - ä¿®æ”¹æ‰‹æœºç‰ˆ */
    .work-top-header {
        background: white;
        padding: 15px 0;
        margin-bottom: 10px;
        border-bottom: 1px solid #eee;
        box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    
    @media (min-width: 768px) {
        .work-top-header {
            position: sticky;
            top: 0;
            z-index: 100;
        }
    }
    
    /* ç”¨æˆ·å’Œæ—¶é—´å¹¶æ’å¸ƒå±€ */
    .user-time-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 10px;
    }
    
    @media (max-width: 767px) {
        .user-time-container {
            grid-template-columns: 1fr;
            gap: 10px;
        }
    }
    
    /* ä¿®æ”¹ï¼šCurrent Useræ˜¾ç¤ºæ”¹ä¸ºä¸€è¡Œ */
    .user-display-box {
        padding: 6px;
        border-radius: 8px;
        font-size: 1.1rem;
        text-align: center;
        font-weight: 600;
        height: auto;
        display: flex;
        flex-direction: column;
        justify-content: center;
        border: 2px solid transparent;
    }
    
    .user-display-box.current-user {
        background: rgba(102, 126, 234, 0.1);
        border-color: #667eea;
        color: #333;
    }
    
    /* Current Useræ˜¾ç¤ºä¸ºä¸€è¡Œ */
    .current-user .user-value {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 0; /* ç§»é™¤ä¸‹è¾¹è· */
    }
    
    .current-user .user-label {
        display: none; /* éšè—"Current User"æ ‡ç­¾ */
    }
    
    .time-display-box {
        padding: 10px;
        border-radius: 8px;
        font-size: 1.1rem;
        text-align: center;
        font-weight: 600;
        height: auto;
        display: flex;
        flex-direction: column;
        justify-content: center;
        border: 2px solid transparent;
    }
    
    .time-display-box.future {
        background: rgba(76, 175, 80, 0.1);
        border-color: #4CAF50;
    }
    
    .time-display-box.past {
        background: rgba(244, 67, 54, 0.1);
        border-color: #f44336;
    }
    
    .time-value, .user-value {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 2px;
    }
    
    .time-label, .user-label {
        font-size: 0.75rem;
        opacity: 0.9;
    }
    
    .time-negative {
        color: #f44336;
        animation: pulse 2s infinite;
    }
    
    .time-positive {
        color: #4CAF50;
    }
    
    /* é‡æ–°è®¾è®¡å›¾çº¸ä¿¡æ¯ä¸²è”æ¡† */
    .drawing-info-summary {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        font-size: 14px;
        color: #333;
        line-height: 1.4;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #ddd;
        margin-bottom: 0;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        align-items: center;
    }
    
    .info-item {
        display: inline-flex;
        align-items: center;
        background: white;
        padding: 3px 8px;
        border-radius: 15px;
        border: 1px solid #ddd;
        font-size: 12px;
        margin: 1px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .info-label {
        font-weight: 600;
        color: #667eea;
        margin-right: 3px;
        font-size: 11px;
    }
    
    .info-separator {
        color: #999;
        font-weight: bold;
        margin: 0 3px;
        font-size: 11px;
    }
    
    /* ç”µè„‘ç‰ˆæ–°å¸ƒå±€ */
    @media (min-width: 768px) {
        .work-main-container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 20px;
            align-items: start;
            position: relative;
        }
        
        .cards-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: sticky;
            top: 150px;
            transition: top 0.3s ease;
            z-index: 10;
            align-self: flex-start;
        }
        
        .info-sidebar {
            position: sticky;
            top: 150px;
            transition: top 0.3s ease;
            z-index: 10;
            align-self: flex-start;
        }
        
        .stack-section {
            display: flex;
            flex-direction: column;
        }
        
        /* ç”µè„‘ç‰ˆä¸“ç”¨ï¼šé˜²æ­¢æ»šåŠ¨è·³åŠ¨ */
        .content-frame {
            overflow-anchor: none !important;
            contain: layout style paint;
        }
        
        .option-item {
            transform: translateZ(0);
        }
    }
    
    /* æ‰‹æœºç‰ˆå¸ƒå±€ - ç§»é™¤å›ºå®šå®šä½ */
    @media (max-width: 767px) {
        .work-main-container {
            display: flex;
            flex-direction: column;
        }
        
        .cards-section {
            order: 3;
            margin-top: 20px;
            position: relative !important;
            top: auto !important;
        }
        
        .stack-section {
            order: 4;
        }
        
        .info-sidebar {
            order: 2;
            margin-top: 15px;
            position: relative !important;
            top: auto !important;
        }
    }
    
    /* å¡ç‰‡æ ·å¼ - ä½¿ç”¨æ–°é¢œè‰² */
    .card-box {
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        transition: all 0.3s ease;
        color: #333;
        text-align: center;
        padding: 15px;
        height: 120px;
        border: 2px solid transparent;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }
    
    .card-box:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    .card-box.selected {
        border-color: #333;
        box-shadow: 0 0 0 3px rgba(102,126,234,0.3), 0 8px 20px rgba(0,0,0,0.15);
    }
    
    /* ä½¿ç”¨æ–°é¢œè‰² */
    .c1 { background: #FFD5D5; } /* çº¢è‰² - Received From */
    .c2 { background: #D7F4F9; } /* è“è‰² - Job Completed */
    .c3 { background: #EBD8FF; } /* ç´«è‰² - Quality Control */
    
    .card-english {
        font-size: 18px;
        margin-bottom: 3px;
    }
    
    .card-chinese {
        font-size: 14px;
        font-weight: normal;
        margin-bottom: 8px;
    }
    
    /* ç”¨æˆ·é€‰æ‹©æ˜¾ç¤º */
    .user-selection {
        font-size: 12px;
        font-weight: normal;
        color: #333;
        background: rgba(255, 255, 255, 0.9);
        padding: 4px 8px;
        border-radius: 4px;
        margin-top: 3px;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        height: 20px;
        min-width: 150px;
        text-align: center;
        border: 1px solid rgba(0,0,0,0.1);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* å†…å®¹iframeåŒºåŸŸ */
    .content-frame {
        width: 100%;
        min-height: 350px;
        border-radius: 10px;
        border: 2px solid #ddd;
        background: #fff;
        padding: 20px;
        overflow-y: auto;
    }
    
    .content-frame:focus {
        outline: none;
    }
    
    .frame-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #667eea;
    }
    
    /* é€‰é¡¹æ ·å¼ */
    .option-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 8px;
        transition: all 0.2s;
        background: #f9f9f9;
        cursor: pointer;
        position: relative;
        border: 1px solid transparent;
    }
    
    .option-item:hover {
        background-color: #f0f0f0;
        border-color: #ccc;
    }
    
    .option-item.selected {
        background-color: #e8f4ff;
        border-color: #667eea;
    }
    
    /* å®Œå…¨è‡ªå®šä¹‰å•é€‰æŒ‰é’® */
    .custom-radio {
        margin-right: 10px;
        margin-top: 2px;
        width: 16px;
        height: 16px;
        border: 2px solid #667eea;
        border-radius: 50%;
        background: white;
        position: relative;
        cursor: pointer;
        flex-shrink: 0;
    }
    
    .custom-radio.selected::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 7px;
        height: 7px;
        background: #667eea;
        border-radius: 50%;
    }
    
    .option-label {
        flex: 1;
        cursor: pointer;
    }
    
    .option-english {
        font-size: 14px;
        color: #333;
        margin-bottom: 2px;
        font-weight: 500;
    }
    
    .option-chinese {
        font-size: 12px;
        color: #666;
    }
    
    /* æ•°é‡è¾“å…¥æ¡†æ ·å¼ */
    .quantity-section {
        margin-top: 15px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 8px;
        border: 1px solid #ddd;
        width: 100%;
        max-width: 350px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .quantity-input-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
        width: 100%;
    }
    
    .quantity-input-container label {
        font-weight: 500;
        color: #555;
        margin-bottom: 3px;
        display: block;
        font-size: 14px;
    }
    
    .quantity-input-container input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        width: 100%;
        box-sizing: border-box;
        cursor: text !important;
        pointer-events: auto !important;
        user-select: auto !important;
        -webkit-user-select: auto !important;
        -moz-user-select: auto !important;
        -ms-user-select: auto !important;
    }
    
    /* å¯†ç è¾“å…¥åŒºåŸŸ */
    .password-section {
        margin-top: 15px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 8px;
        border: 1px solid #ddd;
        width: 100%;
        max-width: 350px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .password-input {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
        width: 100%;
    }
    
    .password-input input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        width: 100%;
        box-sizing: border-box;
        cursor: text !important;
        pointer-events: auto !important;
        user-select: auto !important;
        -webkit-user-select: auto !important;
        -moz-user-select: auto !important;
        -ms-user-select: auto !important;
    }
    
    .password-input button {
        padding: 10px 15px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        font-size: 14px;
    }
    
    .password-input button:hover {
        background: #5a6fd8;
        transform: translateY(-2px);
    }
    
    /* ä¿¡æ¯ä¾§è¾¹æ  */
    .info-sidebar {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        border-left: 4px solid #667eea;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    @media (min-width: 768px) {
        .info-sidebar {
            height: fit-content;
            max-height: 350px;
        }
    }
    
    .sidebar-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .sidebar-item {
        margin-bottom: 12px;
    }
    
    .sidebar-label {
        font-weight: 500;
        color: #555;
        margin-bottom: 3px;
        font-size: 13px;
    }
    
    .sidebar-value {
        font-size: 14px;
        color: #333;
        font-weight: 500;
        background: white;
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #eee;
    }
    
    /* æäº¤æŒ‰é’® */
    .submit-section {
        text-align: center;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    
    .submit-btn { 
        background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); 
        color:white; 
        border:none;
        padding:12px 30px; 
        border-radius:6px; 
        font-size:15px; 
        font-weight:600; 
        cursor:pointer; 
        transition:all 0.3s; 
        min-width: 180px; 
    }
    
    .submit-btn:hover:not(:disabled) { 
        transform:translateY(-2px); 
        box-shadow:0 5px 15px rgba(102,126,234,0.4); 
    }
    
    .submit-btn:disabled { 
        background:#cccccc; 
        cursor: not-allowed;
    }
    
    .submit-btn:active:not(:disabled) { 
        transform:translateY(0); 
    }
    
    .success-message {
        margin-top: 12px;
        padding: 10px;
        background: #d4edda;
        color: #155724;
        border-radius: 6px;
        border: 1px solid #c3e6cb;
        display: none;
        font-size: 14px;
    }
    
    /* éšè—çš„æ‰«ç è¾“å…¥æ¡† */
    #scannerInput {
        opacity: 0;
        position: absolute;
        left: -9999px;
    }
    
    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 600px) {
        .container { padding:15px; }
        h2 { font-size:22px; margin-bottom:15px; }
        .content-frame {
            min-height: 300px;
            padding: 15px;
        }
        .card-box {
            height: 110px;
            padding: 12px;
        }
        .card-english {
            font-size: 16px;
        }
        .card-chinese {
            font-size: 13px;
        }
        .user-selection {
            font-size: 11px;
            padding: 2px 5px;
            min-width: 130px;
        }
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .section {
        display: none;
    }
    
    #drawingSection {
        display: block;
    }
    
    /* æ–°å¢ï¼šæ‰«æå™¨æ§åˆ¶æŒ‰é’® - ç§»é™¤ç»¿è‰²ï¼Œæ”¹ç”¨è“è‰² */
    .scanner-controls {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }
    
    .scanner-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    
    .scanner-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        background: #5a6fd8;
    }
    
    .scanner-btn.stop {
        background: #f44336;
    }
    
    .scanner-btn.stop:hover {
        background: #e53935;
        box-shadow: 0 5px 15px rgba(244,67,54,0.4);
    }
    
    .scanner-btn.switch {
        background: #2196F3;
    }
    
    .scanner-btn.switch:hover {
        background: #1e88e5;
        box-shadow: 0 5px 15px rgba(33,150,243,0.4);
    }
    
    /* æ–°å¢ï¼šå‘˜å·¥æ¬¢è¿ä¿¡æ¯ */
    .employee-welcome {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px;
        border-radius: 8px;
        margin: 12px 0;
        text-align: center;
        display: none;
    }
    
    .welcome-text {
        font-size: 14px;
        color: rgba(255,255,255,0.9);
    }
    
    .employee-name {
        font-size: 18px;
        font-weight: 600;
        margin-top: 3px;
    }
    
    /* æ–°å¢ï¼šæ‰«æçŠ¶æ€æŒ‡ç¤ºå™¨ */
    .scanning-status {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 6px;
        background-color: #4CAF50;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
    }
    
    /* ç¡®è®¤æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        max-width: 500px;
        width: 90%;
        max-height: 80vh; /* æ–°å¢ï¼šé™åˆ¶æœ€å¤§é«˜åº¦ */
        overflow-y: auto; /* æ–°å¢ï¼šæ·»åŠ æ»šåŠ¨ */
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal h3 {
        margin-bottom: 15px;
        color: #2c3e50;
        font-size: 20px;
    }
    
    .modal p {
        margin-bottom: 8px; /* å‡å°‘é—´è· */
        color: #555;
        line-height: 1.4; /* å‡å°‘è¡Œé«˜ */
        text-align: left;
        font-size: 14px;
    }
    
    .modal-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 20px;
    }
    
    .modal-btn {
        padding: 10px 25px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        min-width: 100px;
    }
    
    .modal-btn.yes {
        background: #2ecc71;
        color: white;
    }
    
    .modal-btn.no {
        background: #e74c3c;
        color: white;
    }
    
    .modal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .modal-btn:active {
        transform: translateY(0);
    }
    
    /* è¾“å…¥æ¡†ä¿®å¤æ ·å¼ */
    .clickable-input {
        pointer-events: auto !important;
        cursor: text !important;
        user-select: auto !important;
        -webkit-user-select: auto !important;
        -moz-user-select: auto !important;
        -ms-user-select: auto !important;
    }
    
    #deficiencyInput input:focus,
    .password-input input:focus,
    .quantity-input-container input:focus,
    #jobCompletedQuantity:focus {
        border-color: #667eea !important;
        outline: none !important;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2) !important;
    }
    
    /* ç”µè„‘ç‰ˆæ‘„åƒå¤´æ ·å¼ */
    .camera-instruction {
        font-size: 13px;
        color: #2196F3;
        margin: 8px 0;
        font-weight: 500;
        padding: 6px 10px;
        background: rgba(33, 150, 243, 0.1);
        border-radius: 4px;
        display: inline-block;
    }
    
    /* åŠ è½½å’Œé”™è¯¯æ ·å¼ */
    .loading-container {
        text-align: center;
        padding: 15px;
        display: none;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }
    
    .error-container {
        background-color: #ffeaea;
        border-left: 5px solid #e74c3c;
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 5px;
        display: none;
    }
    
    .error-title {
        color: #c0392b;
        font-weight: 600;
        margin-bottom: 6px;
        font-size: 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* éšè—çš„iframeç”¨äºè¡¨å•æäº¤ */
    .hidden-iframe {
        display: none;
        width: 0;
        height: 0;
        border: none;
    }
    
    /* ========== ç”µè„‘ç‰ˆæ»šåŠ¨ä¿®å¤CSS ========== */
    /* ç”µè„‘ç‰ˆï¼šé˜²æ­¢content-frameå†…éƒ¨æ»šåŠ¨ä½ç½®é‡ç½® */
    @media (min-width: 768px) {
        .content-frame {
            /* å…³é”®ä¿®å¤ï¼šç¦ç”¨æµè§ˆå™¨è‡ªåŠ¨æ»šåŠ¨é‡ç½® */
            overflow-anchor: none !important;
            /* é˜²æ­¢ä»»ä½•è‡ªåŠ¨æ»šåŠ¨è¡Œä¸º */
            scroll-behavior: auto !important;
            /* æé«˜æ¸²æŸ“æ€§èƒ½ */
            contain: layout style paint;
            will-change: transform;
        }
        
        /* ç¡®ä¿é€‰é¡¹ç‚¹å‡»ä¸ä¼šå¼•èµ·æ»šåŠ¨é‡ç½® */
        .option-item, .custom-radio, .option-label {
            /* å¼ºåˆ¶ç¡¬ä»¶åŠ é€Ÿï¼Œé˜²æ­¢å¸ƒå±€æŠ–åŠ¨ */
            transform: translateZ(0);
            /* ç¦ç”¨æ–‡æœ¬é€‰æ‹©ï¼ˆé˜²æ­¢æ‹–æ‹½å¼•èµ·æ»šåŠ¨ï¼‰ */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* å…è®¸è¾“å…¥æ¡†å¯ä»¥é€‰æ‹©æ–‡æœ¬ */
        #deficiencyText, #jobCompletedQuantity, #qcPassword {
            user-select: auto !important;
            -webkit-user-select: auto !important;
        }
    }
    
    /* ========== è´¨é‡æ£€æŸ¥é—®é¢˜æ ·å¼ ========== */
    .qc-question {
        margin-bottom: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 8px;
        border: 1px solid #ddd;
    }
    
    .question-number {
        font-weight: bold;
        color: #667eea;
        margin-right: 8px;
    }
    
    .question-text {
        font-weight: 500;
        color: #333;
        margin-bottom: 12px;
        font-size: 15px;
        line-height: 1.4;
    }
    
    .question-chinese {
        color: #666;
        font-size: 13px;
        margin-top: 4px;
        line-height: 1.3;
    }
    
    .qc-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 10px;
    }
    
    .qc-option-item {
        display: flex;
        align-items: center;
        padding: 8px 10px;
        border-radius: 6px;
        background: white;
        border: 1px solid #ddd;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .qc-option-item:hover {
        background: #f0f0f0;
        border-color: #bbb;
    }
    
    .qc-option-item.selected {
        background: #e8f4ff;
        border-color: #667eea;
    }
    
    .qc-radio {
        margin-right: 10px;
        width: 16px;
        height: 16px;
        border: 2px solid #667eea;
        border-radius: 50%;
        background: white;
        position: relative;
        flex-shrink: 0;
    }
    
    .qc-radio.selected::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 7px;
        height: 7px;
        background: #667eea;
        border-radius: 50%;
    }
    
    .qc-option-text {
        flex: 1;
        font-size: 14px;
    }
    
    .qc-details {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #eee;
    }
    
    .details-label {
        font-size: 13px;
        color: #555;
        margin-bottom: 6px;
        font-weight: 500;
    }
    
    .details-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
        transition: all 0.3s;
        cursor: text !important;
        pointer-events: auto !important;
        user-select: auto !important;
        -webkit-user-select: auto !important;
        -moz-user-select: auto !important;
        -ms-user-select: auto !important;
    }
    
    .details-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    }
    
    /* é”™è¯¯çŠ¶æ€ */
    .error-highlight {
        border: 1px solid #f44336 !important;
        background: #fff5f5 !important;
    }
    
    .error-message {
        color: #f44336;
        font-size: 12px;
        margin-top: 4px;
        display: none;
    }
    
    /* æ–°å¢ï¼šç´§å‡‘çš„QCç­”æ¡ˆæ‘˜è¦æ ·å¼ */
    .qc-summary-compact {
        margin: 10px 0;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #ddd;
        max-height: 250px;
        overflow-y: auto;
    }
    
    .qc-summary-row {
        display: flex;
        align-items: flex-start;
        margin-bottom: 6px;
        padding-bottom: 6px;
        border-bottom: 1px solid #eee;
    }
    
    .qc-summary-row:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .qc-summary-number {
        font-weight: bold;
        color: #667eea;
        min-width: 24px;
        font-size: 13px;
    }
    
    .qc-summary-answer {
        flex: 1;
        font-size: 13px;
        color: #333;
    }
    
    .qc-summary-details {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
        font-style: italic;
    }
</style>
</head>
<body>
<div class="container">
  <!-- é”™è¯¯æ˜¾ç¤º -->
  <div class="error-container" id="errorContainer">
    <div class="error-title" id="errorTitle">Error Title</div>
    <div id="errorMessage">Error details will appear here.</div>
  </div>
  
  <!-- åŠ è½½åŠ¨ç”» -->
  <div class="loading-container" id="loadingContainer">
    <div class="spinner"></div>
    <p>Loading product information...</p>
  </div>
  
  <!-- ===== éšè— input ç”¨äºç”µè„‘ scanner ===== -->
  <input type="text" id="scannerInput" autofocus>

  <!-- ===== ç¡®è®¤æ¨¡æ€æ¡† ===== -->
  <div id="confirmationModal" class="modal">
    <div class="modal-content">
        <h3>Confirm Selection</h3>
        <div id="modalMessage" style="text-align: left; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8bar; border: 1px solid #ddd;">
            <!-- ç¡®è®¤ä¿¡æ¯ä¼šåŠ¨æ€å¡«å……åˆ°è¿™é‡Œ -->
        </div>
        <div class="modal-buttons">
            <button class="modal-btn yes" onclick="confirmSubmit()">Yes</button>
            <button class="modal-btn no" onclick="cancelSubmit()">No</button>
        </div>
    </div>
  </div>

  <!-- ===== éšè—è¡¨å•å’Œiframeç”¨äºæäº¤æ•°æ® ===== -->
  <form id="dataForm" method="post" target="hiddenIframe" style="display: none;">
    <input type="hidden" id="form_timestamp" name="timestamp">
    <input type="hidden" id="form_name" name="name">
    <input type="hidden" id="form_action" name="action">
    <input type="hidden" id="form_spreadsheetId" name="spreadsheetId">
    <input type="hidden" id="form_sheetName" name="sheetName">
    <input type="hidden" id="form_salesOrderNo" name="salesOrderNo">
    <input type="hidden" id="form_itemNo" name="itemNo">
    <!-- 22ä¸ªè´¨é‡æ£€æŸ¥é—®é¢˜çš„å€¼ -->
    <input type="hidden" id="form_qc1" name="qc1">
    <input type="hidden" id="form_qc1_details" name="qc1_details">
    <input type="hidden" id="form_qc2" name="qc2">
    <input type="hidden" id="form_qc2_details" name="qc2_details">
    <input type="hidden" id="form_qc3" name="qc3">
    <input type="hidden" id="form_qc3_details" name="qc3_details">
    <input type="hidden" id="form_qc4" name="qc4">
    <input type="hidden" id="form_qc4_details" name="qc4_details">
    <input type="hidden" id="form_qc5" name="qc5">
    <input type="hidden" id="form_qc5_details" name="qc5_details">
    <input type="hidden" id="form_qc6" name="qc6">
    <input type="hidden" id="form_qc6_details" name="qc6_details">
    <input type="hidden" id="form_qc7" name="qc7">
    <input type="hidden" id="form_qc7_details" name="qc7_details">
    <input type="hidden" id="form_qc8" name="qc8">
    <input type="hidden" id="form_qc8_details" name="qc8_details">
    <input type="hidden" id="form_qc9" name="qc9">
    <input type="hidden" id="form_qc9_details" name="qc9_details">
    <input type="hidden" id="form_qc10" name="qc10">
    <input type="hidden" id="form_qc10_details" name="qc10_details">
    <input type="hidden" id="form_qc11" name="qc11">
    <input type="hidden" id="form_qc11_details" name="qc11_details">
    <input type="hidden" id="form_qc12" name="qc12">
    <input type="hidden" id="form_qc12_details" name="qc12_details">
    <input type="hidden" id="form_qc13" name="qc13">
    <input type="hidden" id="form_qc13_details" name="qc13_details">
    <input type="hidden" id="form_qc14" name="qc14">
    <input type="hidden" id="form_qc14_details" name="qc14_details">
    <input type="hidden" id="form_qc15" name="qc15">
    <input type="hidden" id="form_qc15_details" name="qc15_details">
    <input type="hidden" id="form_qc16" name="qc16">
    <input type="hidden" id="form_qc16_details" name="qc16_details">
    <input type="hidden" id="form_qc17" name="qc17">
    <input type="hidden" id="form_qc17_details" name="qc17_details">
    <input type="hidden" id="form_qc18" name="qc18">
    <input type="hidden" id="form_qc18_details" name="qc18_details">
    <input type="hidden" id="form_qc19" name="qc19">
    <input type="hidden" id="form_qc19_details" name="qc19_details">
    <input type="hidden" id="form_qc20" name="qc20">
    <input type="hidden" id="form_qc20_details" name="qc20_details">
    <input type="hidden" id="form_qc21" name="qc21">
    <input type="hidden" id="form_qc21_details" name="qc21_details">
    <input type="hidden" id="form_qc22" name="qc22">
    <input type="hidden" id="form_qc22_details" name="qc22_details">
  </form>
  <iframe name="hiddenIframe" id="hiddenIframe" class="hidden-iframe"></iframe>

  <!-- ===== é˜¶æ®µ 1ï¼šå›¾çº¸ä¿¡æ¯ ===== -->
  <div id="drawingSection" class="section" style="display:block;">
    <h2>ğŸ“‹ Drawing Information</h2>
    
    <div class="drawing-content">
        <div class="drawing-info">
            <div class="drawing-card">
                <!-- é‡æ–°è®¾è®¡çš„ä¿¡æ¯ç½‘æ ¼å¸ƒå±€ -->
                <div class="form-grid">
                    <div class="form-group">
                        <div class="form-label">Sales Order No.</div>
                        <div class="form-value" id="salesOrderNo">Loading...</div>
                    </div>
                    <div class="form-group">
                        <div class="form-label">Item No.</div>
                        <div class="form-value" id="itemNo">Loading...</div>
                    </div>
                    <div class="form-group">
                        <div class="form-label">Customer Name</div>
                        <div class="form-value" id="customerName">Loading...</div>
                    </div>
                    <div class="form-group">
                        <div class="form-label">Item Name</div>
                        <div class="form-value" id="itemName">Loading...</div>
                    </div>
                    <div class="form-group full-width">
                        <div class="form-label">Dimension</div>
                        <div class="form-value" id="dimension">Loading...</div>
                    </div>
                    <div class="form-group">
                        <div class="form-label">Quantity</div>
                        <div class="form-value" id="quantity">Loading...</div>
                    </div>
                    <div class="form-group">
                        <div class="form-label">Unit of Measurement</div>
                        <div class="form-value" id="unitOfMeasurement">Loading...</div>
                    </div>
                    <div class="form-group full-width">
                        <div class="form-label">Estimated Delivery Date</div>
                        <div class="form-value" id="estimatedDeliveryDate">Loading...</div>
                    </div>
                </div>
                
                <!-- ç¬¬ä¸€é¡µçš„å€’è®¡æ—¶æ¡† -->
                <div id="countdownContainer1" class="countdown-container">
                    <!-- å€’è®¡æ—¶å†…å®¹ä¼šåŠ¨æ€å¡«å…… -->
                </div>
            </div>
        </div>
        
        <div class="scan-section">
            <div class="scan-instruction">Please scan your <b>Credential QR Code</b></div>
            
            <!-- å‘˜å·¥æ¬¢è¿ä¿¡æ¯ -->
            <div class="employee-welcome" id="employeeWelcome">
                <div class="welcome-text">Authenticated as:</div>
                <div class="employee-name" id="employeeNameDisplay"></div>
            </div>
            
            <!-- æ‰«æå™¨æ§åˆ¶æŒ‰é’®å·²ç§»å…¥æ‰«æå™¨åŒºåŸŸ -->
            
            <!-- æ‘„åƒå¤´æ‰«ææç¤º -->
            <div class="camera-instruction" id="cameraInstruction" style="display: none;">
                <span class="scanning-status"></span> Scanning for QR codes...
            </div>
            
            <!-- æ–°çš„æ‰«æå™¨å®¹å™¨ -->
            <div class="scanner-container" id="scannerContainer">
                <div class="scanner-overlay" id="scannerOverlay">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“±</div>
                    <p style="color: #666; margin-bottom: 15px; font-size: 16px;">
                        QR Code Scanner Area
                    </p>
                    
                    <!-- è“è‰²Start CameraæŒ‰é’®å·²ç§»å…¥è¿™é‡Œ -->
                    <div class="scanner-controls" id="scannerControls">
                        <button class="scanner-btn" id="startScanner">
                            <span>ğŸ“·</span> Start Camera
                        </button>
                        <button class="scanner-btn stop" id="stopScanner" style="display: none;">
                            <span>âŒ</span> Stop Camera
                        </button>
                        <button class="scanner-btn switch" id="switchCamera" style="display: none;">
                            <span>ğŸ”„</span> Switch Camera
                        </button>
                    </div>
                    
                    <div class="scanner-status">
                        <div style="margin-top: 15px; font-size: 13px; color: #888;">
                            Supports both front and back cameras
                        </div>
                    </div>
                </div>
                <video id="scannerVideo" playsinline></video>
                <canvas id="scannerCanvas"></canvas>
            </div>
            
            <!-- GIFå®¹å™¨å·²ç§»é™¤ -->
        </div>
    </div>
  </div>

  <!-- ===== é˜¶æ®µ 2ï¼šå·¥ä½œæ•°æ®å½•å…¥é¡µé¢ ===== -->
  <div id="workSection" class="section">
    <!-- ä¿®æ”¹ï¼šç§»é™¤æ ‡é¢˜ "ğŸ“ Work Data Entry" -->
    
    <!-- é¡¶éƒ¨å›ºå®šå¤´éƒ¨ -->
    <div class="work-top-header">
        <!-- ç”¨æˆ·å’Œæ—¶é—´å¹¶æ’æ˜¾ç¤º -->
        <div class="user-time-container">
            <div class="user-display-box current-user" id="userDisplay">
                <!-- ä¿®æ”¹ï¼šCurrent Useræ˜¾ç¤ºä¸ºä¸€è¡Œ -->
                <div class="user-value" id="currentUserName">Current Userï¼šNot authenticated</div>
            </div>
            <div class="time-display-box" id="countdownContainer2">
                <!-- æ—¶é—´å†…å®¹ä¼šåŠ¨æ€å¡«å…… -->
            </div>
        </div>
        
        <!-- é‡æ–°è®¾è®¡çš„å›¾çº¸ä¿¡æ¯ä¸²è”æ¡† -->
        <div class="drawing-info-summary" id="drawingInfoSummary" style="display: none;">
            <!-- å›¾çº¸ä¿¡æ¯ä¼šåŠ¨æ€å¡«å…… -->
        </div>
    </div>
    
    <div class="work-main-container">
        <!-- å·¦ä¾§ï¼šå¡ç‰‡é€‰æ‹©åŒºåŸŸ -->
        <div class="cards-section">
            <div class="card-box c1 selected" data-card-index="0">
                <div class="card-english">Received From</div>
                <div class="card-chinese">ä»å“ªæ”¶åˆ°</div>
                <div class="user-selection" id="cardSelection0"></div>
            </div>
            <div class="card-box c2" data-card-index="1">
                <div class="card-english">Job Completed</div>
                <div class="card-chinese">å·²å®Œæˆçš„å·¥ä½œ</div>
                <div class="user-selection" id="cardSelection1"></div>
            </div>
            <div class="card-box c3" data-card-index="2">
                <div class="card-english">Quality Control</div>
                <div class="card-chinese">è´¨é‡æ£€æŸ¥</div>
                <div class="user-selection" id="cardSelection2"></div>
            </div>
        </div>
        
        <!-- ä¸­é—´ï¼šå†…å®¹åŒºåŸŸ -->
        <div class="stack-section">
            <div class="content-frame" id="contentFrame" tabindex="-1">
                <!-- å†…å®¹ä¼šé€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
            
            <!-- æäº¤æŒ‰é’® -->
            <div class="submit-section">
                <button id="submitBtn" class="submit-btn">Submit Data</button>
                <div id="successMessage" class="success-message">
                    âœ… Data successfully submitted!
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šLast Userä¿¡æ¯ä¾§è¾¹æ  -->
        <div class="info-sidebar">
            <div class="sidebar-title">Last User Information</div>
            <div class="sidebar-item">
                <div class="sidebar-label">Last User</div>
                <div class="sidebar-value" id="lastUserValue">-</div>
            </div>
            <div class="sidebar-item">
                <div class="sidebar-label">Last User Status</div>
                <div class="sidebar-value" id="lastUserStatusValue">-</div>
            </div>
            <div class="sidebar-item">
                <div class="sidebar-label">Last User Selection</div>
                <div class="sidebar-value" id="lastUserSelectionValue">-</div>
            </div>
        </div>
    </div>
  </div>
</div>

<script>
// ========== ä»HTML 1å¯¼å…¥çš„æ ¸å¿ƒæœºåˆ¶ ==========
// Function to decode base64 string
function decodeBase64(str) {
    try {
        // Base64 decoding with proper handling
        return decodeURIComponent(atob(str).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
    } catch (error) {
        console.error('Base64 decoding error:', error);
        throw new Error('Invalid base64 encoding');
    }
}

// Function to parse URL parameters
function getUrlParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    const encodedData = urlParams.get('H');
    
    if (!encodedData) {
        // å¦‚æœæ²¡æœ‰URLå‚æ•°ï¼Œè¿”å›nullè¡¨ç¤ºquerystringä¸å­˜åœ¨
        console.log('No URL parameters found');
        return null;
    }
    
    try {
        // Decode the base64 parameter
        const decodedString = decodeBase64(encodedData);
        
        // Split by & to get Sales Order No. and Item No.
        const parts = decodedString.split('&');
        
        if (parts.length !== 2) {
            console.error('Decoded data does not contain Sales Order No. and Item No. separated by &');
            return null;
        }
        
        return {
            salesOrderNo: parts[0],
            itemNo: parts[1],
            fullString: decodedString
        };
    } catch (error) {
        console.error('Error decoding URL parameters:', error);
        return null;
    }
}

// Function to fetch data from Google Apps Script
async function fetchProductData(salesOrderNo, itemNo) {
    // ä½¿ç”¨ç°æœ‰çš„GAS 1 web app URL
    const gasWebAppUrl = 'https://script.google.com/macros/s/AKfycbxiai_Z57GpnMifiwT90ByYj62pRemZLOzHZIRGbukKnhjx12Ed_EBUbF6cb_XFF6bs/exec';
    
    const response = await fetch(`${gasWebAppUrl}?salesOrderNo=${encodeURIComponent(salesOrderNo)}&itemNo=${encodeURIComponent(itemNo)}`);
    
    if (!response.ok) {
        throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
    }
    
    return await response.json();
}

// æ–°å¢å‡½æ•°ï¼šè·å–æœ€åä¸€è¡Œç”¨æˆ·æ•°æ®
async function fetchLastUserData(salesOrderNo, itemNo) {
    try {
        // ä½¿ç”¨GAS Web Appçš„getLastUserå‚æ•°
        const gasWebAppUrl = 'https://script.google.com/macros/s/AKfycbxiai_Z57GpnMifiwT90ByYj62pRemZLOzHZIRGbukKnhjx12Ed_EBUbF6cb_XFF6bs/exec';
        
        const response = await fetch(`${gasWebAppUrl}?salesOrderNo=${encodeURIComponent(salesOrderNo)}&itemNo=${encodeURIComponent(itemNo)}&getLastUser=true`);
        
        if (!response.ok) {
            throw new Error(`Failed to fetch last user data: ${response.status} ${response.statusText}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('Error fetching last user data:', error);
        return {
            success: false,
            lastUser: '-',
            lastUserStatus: '-',
            lastUserSelection: '-'
        };
    }
}

// Function to calculate time difference between EDD (8:00 AM) and now
function calculateTimeRemaining(eddDateString) {
    if (!eddDateString || eddDateString === 'N/A' || eddDateString === 'Not available' || eddDateString === '-') {
        return {
            isValid: false,
            message: 'No EDD provided'
        };
    }
    
    try {
        // Parse the EDD date (assuming format YYYY-MM-DD)
        let eddDate;
        if (eddDateString.includes('/')) {
            // Handle DD/MM/YYYY format
            const parts = eddDateString.split('/');
            eddDate = new Date(parts[2], parts[1] - 1, parts[0]);
        } else {
            // Try standard date parsing
            eddDate = new Date(eddDateString);
        }
        
        if (isNaN(eddDate.getTime())) {
            return {
                isValid: false,
                message: 'Invalid date format'
            };
        }
        
        // Set time to 8:00 AM
        eddDate.setHours(8, 0, 0, 0);
        
        const now = new Date();
        
        // Calculate difference in milliseconds
        const diffMs = eddDate - now;
        
        // Calculate days, hours, minutes, seconds
        const diffSeconds = Math.floor(Math.abs(diffMs) / 1000);
        const diffMinutes = Math.floor(diffSeconds / 60);
        const diffHours = Math.floor(diffMinutes / 60);
        const diffDays = Math.floor(diffHours / 24);
        
        const remainingSeconds = diffSeconds % 60;
        const remainingMinutes = diffMinutes % 60;
        const remainingHours = diffHours % 24;
        
        // Determine if EDD is in future or past
        const isFuture = diffMs > 0;
        
        return {
            isValid: true,
            isFuture: isFuture,
            diffMs: diffMs,
            days: diffDays,
            hours: remainingHours,
            minutes: remainingMinutes,
            seconds: remainingSeconds,
            totalSeconds: diffSeconds,
            eddDateTime: eddDate,
            currentTime: now,
            formattedEDD: eddDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })
        };
    } catch (error) {
        console.error('Error calculating time remaining:', error);
        return {
            isValid: false,
            message: 'Invalid date format'
        };
    }
}

// Function to format time remaining for display in first page
function formatTimeRemaining(timeData) {
    if (!timeData.isValid) {
        return `<div style="color: #666; text-align: center; padding: 20px;">
                    <div style="font-size: 1.2rem; margin-bottom: 10px; color: #f44336;">âš ï¸</div>
                    <div>Please contact Admin for further assistance</div>
                </div>`;
    }
    
    if (timeData.isFuture) {
        return `
            <div class="countdown-container future">
                <div class="countdown-value countdown-positive">
                    ${timeData.days}d ${timeData.hours}h ${timeData.minutes}m ${timeData.seconds}s
                </div>
                <div class="countdown-label">
                    Remaining until EDD (8:00 AM)
                </div>
            </div>
        `;
    } else {
        return `
            <div class="countdown-container past">
                <div class="countdown-value countdown-negative">
                    ${timeData.days}d ${timeData.hours}h ${timeData.minutes}m ${timeData.seconds}s
                </div>
                <div class="countdown-label">
                    Exceeded EDD (8:00 AM)
                </div>
            </div>
        `;
    }
}

// Function to format time remaining for second page
function formatTimeRemainingWorkPage(timeData) {
    if (!timeData.isValid) {
        return `<div style="color: #666; text-align: center; padding: 20px;">
                    <div style="font-size: 1.2rem; margin-bottom: 10px; color: #f44336;">âš ï¸</div>
                    <div>Please contact Admin for further assistance</div>
                </div>`;
    }
    
    if (timeData.isFuture) {
        return `
            <div class="time-display-box future">
                <div class="time-value time-positive">
                    ${timeData.days}d ${timeData.hours}h ${timeData.minutes}m ${timeData.seconds}s
                </div>
                <div class="time-label">
                    Remaining until EDD (8:00 AM)
                </div>
            </div>
        `;
    } else {
        return `
            <div class="time-display-box past">
                <div class="time-value time-negative">
                    ${timeData.days}d ${timeData.hours}h ${timeData.minutes}m ${timeData.seconds}s
                </div>
                <div class="time-label">
                    Exceeded EDD (8:00 AM)
                </div>
            </div>
        `;
    }
}

// Function to update the countdown in real-time
function startCountdown(eddDateString) {
    if (!eddDateString || eddDateString === 'N/A' || eddDateString === 'Not available' || eddDateString === '-') {
        // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„EDDï¼Œæ˜¾ç¤ºè”ç³»ç®¡ç†å‘˜ä¿¡æ¯
        const countdownContainer1 = document.getElementById('countdownContainer1');
        if (countdownContainer1) {
            countdownContainer1.innerHTML = `<div style="color: #666; text-align: center; padding: 20px;">
                                                <div style="font-size: 1.2rem; margin-bottom: 10px; color: #f44336;">âš ï¸</div>
                                                <div>Please contact Admin for further assistance</div>
                                            </div>`;
        }
        
        const countdownContainer2 = document.getElementById('countdownContainer2');
        if (countdownContainer2) {
            countdownContainer2.innerHTML = `<div style="color: #666; text-align: center; padding: 20px;">
                                                <div style="font-size: 1.2rem; margin-bottom: 10px; color: #f44336;">âš ï¸</div>
                                                <div>Please contact Admin for further assistance</div>
                                            </div>`;
        }
        return null;
    }
    
    // Update countdown every second
    const countdownInterval = setInterval(() => {
        const timeData = calculateTimeRemaining(eddDateString);
        
        if (timeData.isValid) {
            // Update first page countdown
            const countdownContainer1 = document.getElementById('countdownContainer1');
            if (countdownContainer1) {
                countdownContainer1.innerHTML = formatTimeRemaining(timeData);
            }
            
            // Update second page countdown
            const countdownContainer2 = document.getElementById('countdownContainer2');
            if (countdownContainer2) {
                countdownContainer2.innerHTML = formatTimeRemainingWorkPage(timeData);
            }
        } else {
            clearInterval(countdownInterval);
        }
    }, 1000);
    
    // Initial update
    const timeData = calculateTimeRemaining(eddDateString);
    const countdownContainer1 = document.getElementById('countdownContainer1');
    if (countdownContainer1) {
        countdownContainer1.innerHTML = formatTimeRemaining(timeData);
    }
    
    const countdownContainer2 = document.getElementById('countdownContainer2');
    if (countdownContainer2) {
        countdownContainer2.innerHTML = formatTimeRemainingWorkPage(timeData);
    }
    
    return countdownInterval;
}

// Function to show error
function showError(title, message) {
    document.getElementById('errorTitle').textContent = title;
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorContainer').style.display = 'block';
    document.getElementById('loadingContainer').style.display = 'none';
}

// Function to hide error
function hideError() {
    document.getElementById('errorContainer').style.display = 'none';
}

// Function to display product data in form
function displayProductData(data, isDefault = false) {
    if (isDefault) {
        // å½“æ²¡æœ‰querystringæˆ–æ— æ³•è§£ææ—¶ï¼Œæ˜¾ç¤º"-"
        document.getElementById('salesOrderNo').textContent = '-';
        document.getElementById('itemNo').textContent = '-';
        document.getElementById('customerName').textContent = '-';
        document.getElementById('itemName').textContent = '-';
        document.getElementById('dimension').textContent = '-';
        document.getElementById('quantity').textContent = '-';
        document.getElementById('unitOfMeasurement').textContent = '-';
        document.getElementById('estimatedDeliveryDate').textContent = '-';
        
        // Store drawing info for later use
        drawingInfo.salesOrder = '-';
        drawingInfo.itemNo = '-';
        drawingInfo.customerName = '-';
        drawingInfo.itemName = '-';
        drawingInfo.dimension = '-';
        drawingInfo.quantity = '-';
        drawingInfo.unit = '-';
        drawingInfo.deliveryDate = '-';
    } else {
        // Update all form fields
        document.getElementById('salesOrderNo').textContent = data.salesOrderNo || '-';
        document.getElementById('itemNo').textContent = data.itemNo || '-';
        document.getElementById('customerName').textContent = data.customerName || '-';
        
        // ä¿®å¤Item Nameæ˜¾ç¤ºé—®é¢˜ - ä¸å†ä½¿ç”¨æ¢è¡Œï¼Œç›´æ¥æ˜¾ç¤ºåœ¨ä¸€è¡Œ
        const itemNameElement = document.getElementById('itemName');
        if (data.itemNameMain && data.itemNameSub) {
            itemNameElement.textContent = `${data.itemNameMain} ${data.itemNameSub}`;
        } else if (data.itemName) {
            // å¦‚æœitemNameä¸­åŒ…å«<br>ï¼Œæ›¿æ¢ä¸ºç©ºæ ¼
            itemNameElement.textContent = data.itemName.replace(/<br>/g, ' ').replace(/\n/g, ' ');
        } else {
            itemNameElement.textContent = '-';
        }
        
        document.getElementById('dimension').textContent = data.dimension || '-';
        document.getElementById('quantity').textContent = data.quantity || '-';
        document.getElementById('unitOfMeasurement').textContent = data.unitOfMeasurement || '-';
        document.getElementById('estimatedDeliveryDate').textContent = data.estimatedDeliveryDate || '-';
        
        // Store drawing info for later use
        drawingInfo.salesOrder = data.salesOrderNo || '-';
        drawingInfo.itemNo = data.itemNo || '-';
        drawingInfo.customerName = data.customerName || '-';
        drawingInfo.itemName = data.itemName ? data.itemName.replace(/<br>/g, ' ').replace(/\n/g, ' ') : '-';
        drawingInfo.dimension = data.dimension || '-';
        drawingInfo.quantity = data.quantity || '-';
        drawingInfo.unit = data.unitOfMeasurement || '-';
        drawingInfo.deliveryDate = data.estimatedDeliveryDate || '-';
        
        // å­˜å‚¨ç›®æ ‡è¡¨æ ¼ä¿¡æ¯ç”¨äºæäº¤
        if (data.sourceInfo) {
            targetSpreadsheetInfo.spreadsheetId = data.sourceInfo.spreadsheetId;
            targetSpreadsheetInfo.sheetName = data.sourceInfo.sheetName;
            targetSpreadsheetInfo.rowNumber = data.sourceInfo.rowNumber;
        }
    }
}

// ========== åŸå§‹HTML 2çš„å˜é‡å’Œå‡½æ•° ==========
// å‘˜å·¥æ˜ å°„æ•°æ® - ä»æ‚¨æä¾›çš„ä¾‹å­ä¸­æå–
const EMPLOYEE_MAP = {
    'Cassandra-7UVPYdf2XR594Zpe': 'Cassandra',
    'Ethan-Chuu-Gpc23kQxF8Z9tB17': 'Ethan Chuu',
    'Victor-So-R4CwQ2ZY9NvbDhST': 'Victor So',
    'Albert-nX4G9VmZ8eH2CLaD': 'Albert',
    'Aung-Thant-P3JdM6KQ4BqvARZ5': 'Aung Thant',
    'Bunyau-wZ2sF8mP1HkQ3DVL': 'Bunyau',
    'Chin-Sau-Ying-Q9T2gA5XvM8JZb4c': 'Chin Sau Ying',
    'Edika-LrF7W6eZV4sC3PN5': 'Edika',
    'Han-Lin-Maung-8DqZKT9WHXQpM32A': 'Han Lin Maung',
    'Lee-Lung-Chay-C4VZsT2m76gYLRN1': 'Lee Lung Chay',
    'Luna-tXq4m89P3bKZHEVg': 'Luna',
    'Myo-Min-Naing-2XQVf9cDyPWL7M8k': 'Myo Min Naing',
    'Peter-Seah-a9CZTq73r4XHB8nG': 'Peter Seah',
    'Piang-Soe-K7s4pP98tV2HGDJx': 'Piang Soe',
    'Terrence-MZC4nsp8B6L1y2F9': 'Terrence',
    'Wai-Phyo-f3XvGMkQ6NDTWP98': 'Wai Phyo',
    'William-Choo-Y62T4PH9NVxAEZ3k': 'William Choo',
    'Wong-Chok-Poh-sD7VAX4pW1fheN92': 'Wong Chok Poh',
    'Jessie-Tew-H8C2GNPaX1DLRQtv': 'Jessie Tew',
    'Shirley-Tew-WN6AsPeKZC97fqB3': 'Shirley Tew',
    'Cyril-ZYLfM3Bv859aDRcQ': 'Cyril',
    'Ocean-Chuu-T24pkC8M9GZ6NWAV': 'Ocean Chuu',
    'Kuan-3x8BRtq6EQfMPSHd': 'Kuan',
    'Ghan-bT7EYUd6QRgsC4Vk': 'Ghan',
    'Michelle-Tew-DBRT2EC3S9kqKhlx': 'Michelle Tew',
    'Ko-Gyi-sPTZ1Vg6YxJWhb8k': 'Ko Gyi',
    'Zue-Hlang-Htoo-V3CSX4qL8K9WuZte': 'Zue Hlang Htoo',
    'Tun-Myint-Aung-Q7AfJNbXzt3EVc46': 'Tun Myint Aung'
};

// æ–°å¢ï¼šç‰¹å®šç”¨æˆ·åˆ—è¡¨ï¼ˆä¸éœ€è¦å¡«å†™Quantityé—®é¢˜çš„ç”¨æˆ·ï¼‰
const JOB_COMPLETED_USERS_NO_QUANTITY = [
    'Cassandra',
    'Ethan Chuu',
    'Victor So',
    'Jessie Tew',
    'Shirley Tew',
    'Cyril',
    'Ocean Chuu',
    'Kuan',
    'Michelle Tew',
    'Ghan'
];

// å…¨å±€å˜é‡
let scannerVideo, scannerCanvas, scannerContext, scannerOverlay;
let scannerInput, drawingSection, workSection, drawingInfoSummary;
let cameraInstruction, startScannerBtn, stopScannerBtn, switchCameraBtn;
let employeeWelcome, employeeNameDisplay;
let currentUser = "";
let currentCardIndex = 0;
let selectedOptions = {
    receivedFrom1: null,
    receivedFrom2: null,
    jobCompleted: null,
    qualityControl: null
};
let jobCompletedQuantity = ""; // æ–°å¢ï¼šå­˜å‚¨Job Completedçš„äº§å“æ•°é‡
let isSubmitted = false;
let qcUnlocked = false;
let countdownInterval = null;

// äºŒç»´ç æ‰«æç›¸å…³å˜é‡
let qrScannerActive = false;
let videoStream = null;
let currentFacingMode = "environment"; // é»˜è®¤åç½®æ‘„åƒå¤´
let html5QrcodeScanner = null; // ç”¨äºæ‰‹æœºç‰ˆçš„html5-qrcode
let isMobileDevice = false;

// å­˜å‚¨å›¾çº¸ä¿¡æ¯
let drawingInfo = {
    salesOrder: "-",
    itemNo: "-",
    customerName: "-",
    itemName: "-",
    dimension: "-",
    quantity: "-",
    unit: "-",
    deliveryDate: "-"
};

// å­˜å‚¨ç›®æ ‡è¡¨æ ¼ä¿¡æ¯
let targetSpreadsheetInfo = {
    spreadsheetId: "",
    sheetName: "",
    rowNumber: 0
};

// å­˜å‚¨è´¨é‡æ£€æŸ¥æ•°æ®
let qcData = {
    qc1: { selected: null, details: '' },
    qc2: { selected: null, details: '' },
    qc3: { selected: null, details: '' },
    qc4: { selected: null, details: '' },
    qc5: { selected: null, details: '' },
    qc6: { selected: null, details: '' },
    qc7: { selected: null, details: '' },
    qc8: { selected: null, details: '' },
    qc9: { selected: null, details: '' },
    qc10: { selected: null, details: '' },
    qc11: { selected: null, details: '' },
    qc12: { selected: null, details: '' },
    qc13: { selected: null, details: '' },
    qc14: { selected: null, details: '' },
    qc15: { selected: null, details: '' },
    qc16: { selected: null, details: '' },
    qc17: { selected: null, details: '' },
    qc18: { selected: null, details: '' },
    qc19: { selected: null, details: '' },
    qc20: { selected: null, details: '' },
    qc21: { selected: null, details: '' },
    qc22: { selected: null, details: '' }
};

// è´¨é‡æ£€æŸ¥é—®é¢˜æ•°æ®
const QC_QUESTIONS = [
    {
        id: 'qc1',
        en: 'Conformance of the finished product to its intended design functionality',
        cn: 'æˆå“æ˜¯å¦æ»¡è¶³å…¶é¢„æœŸçš„è®¾è®¡åŠŸèƒ½',
        options: [
            { en: 'Conform', cn: 'æ»¡è¶³' },
            { en: 'Not Conform', cn: 'ä¸æ»¡è¶³' }
        ]
    },
    {
        id: 'qc2',
        en: 'Conformance of metal material thickness to drawing',
        cn: 'é‡‘å±ææ–™åšåº¦æ˜¯å¦ç¬¦åˆå›¾çº¸ï¼Ÿ',
        options: [
            { en: 'Conform', cn: 'ç¬¦åˆ' },
            { en: 'Not Conform', cn: 'ä¸ç¬¦åˆ' }
        ]
    },
    {
        id: 'qc3',
        en: 'Based on the drawing, the accuracy of the finished product\'s dimensions',
        cn: 'ä»¥å›¾çº¸ä¸ºä¾æ®ï¼Œæˆå“å°ºå¯¸çš„æ˜¯å¦å‡†ç¡®',
        options: [
            { en: 'Accurate', cn: 'å‡†ç¡®' },
            { en: 'Deviant', cn: 'åç¦»' }
        ]
    },
    {
        id: 'qc4',
        en: 'The appearance/structure of finished product matches the drawing?',
        cn: 'æˆå“å¤–å½¢/ç»“æ„æ˜¯å¦ç¬¦åˆå›¾çº¸?',
        options: [
            { en: 'Match', cn: 'ç¬¦åˆ' },
            { en: 'Mismatch', cn: 'ä¸ç¬¦åˆ' }
        ]
    },
    {
        id: 'qc5',
        en: 'Surface condition of finished productï¼Ÿï¼ˆPlease describe dented areaï¼‰',
        cn: 'æˆå“è¡¨é¢æ˜¯å¦å‡¹é™·ï¼Ÿ(è¯·æè¿°å‡¹é™·åŒºåŸŸï¼‰',
        options: [
            { en: 'Flat', cn: 'å¹³æ•´' },
            { en: 'Dent', cn: 'å‡¹é™·' }
        ]
    },
    {
        id: 'qc6',
        en: 'Finishing of the surface of finished product matches the drawing?',
        cn: 'æˆå“è¡¨é¢è‰²æ³½/çº¹è·¯æ˜¯å¦ç¬¦åˆå›¾çº¸?',
        options: [
            { en: 'Match', cn: 'ç¬¦åˆ' },
            { en: 'Mismatch', cn: 'ä¸ç¬¦åˆ' }
        ]
    },
    {
        id: 'qc7',
        en: 'Completely Cleanï¼Ÿ(Please describe the unclean areas/locations)',
        cn: 'æ˜¯å¦å®Œæ•´æ¸…æ´—å¹²å‡€? (è¯·æè¿°ä¸å¹²å‡€çš„ä½ç½®ï¼‰',
        options: [
            { en: 'Clean', cn: 'å¹²å‡€' },
            { en: 'Finger Print', cn: 'æŒ‡çº¹' },
            { en: 'Chemical Stain', cn: 'åŒ–å­¦ç—•è¿¹' },
            { en: 'Marker Pen Mark', cn: 'è®°å·ç¬”ç—•è¿¹' },
            { en: 'Laser Film', cn: 'æ¿€å…‰è†œ' },
            { en: 'Welding Stain', cn: 'ç„Šæ¥æ±¡æ¸' }
        ]
    },
    {
        id: 'qc8',
        en: 'Sharp Edge/Corner? (Please describe the sharp areas/locations)',
        cn: 'æˆå“çš„è¾¹ç¼˜/è§’å¤´æ˜¯å¦é”åˆ©? (è¯·æè¿°é”åˆ©åŒºåŸŸ)',
        options: [
            { en: 'Smooth', cn: 'å¹³æ»‘' },
            { en: 'Sharp', cn: 'é”åˆ©' }
        ]
    },
    {
        id: 'qc9',
        en: 'Is the overall welding qualified? (Please describe the area of welding that disqualified)',
        cn: 'ç„Šæ¥æ•´ä½“æ˜¯å¦åˆæ ¼ï¼Ÿ(è¯·æè¿°ç„Šæ¥ä¸åˆæ ¼çš„åŒºåŸŸï¼‰',
        options: [
            { en: 'Not applicable', cn: 'ä¸é€‚ç”¨' },
            { en: 'Qualified', cn: 'åˆæ ¼' },
            { en: 'Disqualified', cn: 'ä¸åˆæ ¼' }
        ]
    },
    {
        id: 'qc10',
        en: 'The suitability of the tightness of the equipment parts (Exp: Glass, Acrylic)',
        cn: 'è®¾å¤‡éƒ¨ä»¶ç´§å›ºç¨‹åº¦çš„é€‚å®œæ€§ (ä¾‹å¦‚ï¼šç»ç’ƒã€äºšå…‹åŠ›)',
        options: [
            { en: 'Not applicable', cn: 'ä¸é€‚ç”¨' },
            { en: 'Best fit', cn: 'åˆé€‚' },
            { en: 'Unfit (too tight/too loose)', cn: 'ä¸åˆé€‚ (å¤ªç´§/å¤ªæ¾ï¼‰' },
            { en: 'Install at site', cn: 'åœ¨ç°åœºå®‰è£…' }
        ]
    },
    {
        id: 'qc11',
        en: 'Correctness of the types and thickness of the glass',
        cn: 'ç»ç’ƒçš„ç§ç±»ä¸åšåº¦æ˜¯å¦æ­£ç¡®',
        options: [
            { en: 'Not applicable', cn: 'ä¸é€‚ç”¨' },
            { en: 'Correct', cn: 'æ­£ç¡®' },
            { en: 'Incorrect', cn: 'ä¸æ­£ç¡®' }
        ]
    },
    {
        id: 'qc12',
        en: 'Smoothness of Moving Parts? (Hinge, Handle, Drawer, Wheel)',
        cn: 'å¯ç§»åŠ¨éƒ¨ä»¶æ˜¯å¦é¡ºç•… ï¼Ÿ(é“°é“¾, æŠŠæ‰‹, æŠ½å±‰ , è½®å­ï¼‰',
        options: [
            { en: 'Not applicable', cn: 'ä¸é€‚ç”¨' },
            { en: 'Smooth', cn: 'é¡ºç•…' },
            { en: 'Hindered', cn: 'ä¸é¡ºç•…' }
        ]
    },
    {
        id: 'qc13',
        en: 'Water Leakingï¼Ÿ',
        cn: 'æ˜¯å¦æ¼æ°´ï¼Ÿ',
        options: [
            { en: 'Not applicable', cn: 'ä¸é€‚ç”¨' },
            { en: 'Water leakage', cn: 'æ¼æ°´' },
            { en: 'Leak-proof', cn: 'ä¸æ¼æ°´' }
        ]
    },
    {
        id: 'qc14',
        en: 'Water able to flow out of finished product? (Sink, Bain marie, Exhaust hood, Water boiler, Drainage channel)',
        cn: 'æ°´èƒ½å¦ä»æˆå“æµå‡ºï¼Ÿ(æ°´æ§½ã€ä¿æ¸©é”…ã€æ’æ°”ç½©ã€çƒ­æ°´å™¨ã€æ’æ°´æ²Ÿ)',
        options: [
            { en: 'Not applicable', cn: 'ä¸é€‚ç”¨' },
            { en: 'Able to flow out', cn: 'èƒ½æµå‡º' },
            { en: 'Unable to flow out', cn: 'ä¸èƒ½æµå‡º' }
        ]
    },
    {
        id: 'qc15',
        en: 'Electrical Product Functioningï¼Ÿ',
        cn: 'ç”µå™¨æ˜¯å¦èƒ½è¿ä½œï¼Ÿ',
        options: [
            { en: 'Not applicable', cn: 'ä¸é€‚ç”¨' },
            { en: 'Functioning', cn: 'èƒ½è¿ä½œ' },
            { en: 'Not Functioning', cn: 'ä¸èƒ½è¿ä½œ' }
        ]
    },
    {
        id: 'qc16',
        en: 'Gas Pipe Leakingï¼Ÿ',
        cn: 'ç…¤æ°”ç®¡æ˜¯å¦æ¼æ°”?',
        options: [
            { en: 'Not applicable', cn: 'ä¸é€‚ç”¨' },
            { en: 'Gas leakage', cn: 'æ¼æ°”' },
            { en: 'Leak-proof', cn: 'ä¸æ¼æ°”' }
        ]
    },
    {
        id: 'qc17',
        en: 'HL Logo molded according to drawing?',
        cn: 'æ˜¯å¦æ ¹æ®å›¾çº¸å°ä¸ŠHLæ ‡å¿—?',
        options: [
            { en: 'Drawing has HL Logo, product has HL Logo', cn: 'å›¾çº¸æœ‰HLæ ‡å¿—ï¼Œäº§å“æœ‰HLæ ‡å¿—' },
            { en: 'Drawing has HL Logo, product no HL Logo', cn: 'å›¾çº¸æœ‰HLæ ‡å¿—ï¼Œäº§å“æ²¡HLæ ‡å¿—' },
            { en: 'Drawing no HL Logo, product has HL Logo', cn: 'å›¾çº¸æ²¡HLæ ‡å¿—ï¼Œäº§å“æœ‰HLæ ‡å¿—' },
            { en: 'Drawing no HL Logo, product no HL Logo', cn: 'å›¾çº¸æ²¡HLæ ‡å¿—ï¼Œäº§å“æ²¡HLæ ‡å¿—' }
        ]
    },
    {
        id: 'qc18',
        en: 'Wheel Paste with Masking Tape',
        cn: 'è½®æ˜¯å¦è´´ä¸Šèƒ¶çº¸',
        options: [
            { en: 'Not applicable', cn: 'ä¸é€‚ç”¨' },
            { en: 'Pasted', cn: 'è´´äº†' },
            { en: 'Did not paste', cn: 'æ²¡è´´' }
        ]
    },
    {
        id: 'qc19',
        en: 'Wheel rollableï¼Ÿ',
        cn: 'è½®æ˜¯å¦èƒ½æ»šåŠ¨ï¼Ÿ',
        options: [
            { en: 'Not applicable', cn: 'ä¸é€‚ç”¨' },
            { en: 'Rollable', cn: 'èƒ½æ»šåŠ¨' },
            { en: 'Stuck', cn: 'ä¸èƒ½æ»šåŠ¨' }
        ]
    },
    {
        id: 'qc20',
        en: 'Brake of the wheel functioning?',
        cn: 'è½®çš„åˆ¹è½¦æ˜¯å¦èµ·ä½œç”¨ï¼Ÿ',
        options: [
            { en: 'Not applicable', cn: 'ä¸é€‚ç”¨' },
            { en: 'Functioning', cn: 'èµ·ä½œç”¨' },
            { en: 'Not Functioning', cn: 'å¤±æ•ˆ' }
        ]
    },
    {
        id: 'qc21',
        en: 'Bullet Feet Adjustableï¼Ÿ',
        cn: 'å¯è°ƒèŠ‚çš„æ¡Œè§’èƒ½å¦è°ƒèŠ‚ï¼Ÿ',
        options: [
            { en: 'Not applicable', cn: 'ä¸é€‚ç”¨' },
            { en: 'Adjustable', cn: 'èƒ½è°ƒèŠ‚' },
            { en: 'Unable to adjust', cn: 'æ— æ³•è°ƒèŠ‚' }
        ]
    },
    {
        id: 'qc22',
        en: 'Other Quality Control Features',
        cn: 'å…¶ä»–è´¨æ£€é¡¹ç›®',
        options: [] // ç¬¬22é¢˜æ²¡æœ‰é€‰é¡¹
    }
];

// GAS Web App URL for submitting QC data
const GAS_QC_SUBMIT_URL = 'https://script.google.com/macros/s/AKfycbxiai_Z57GpnMifiwT90ByYj62pRemZLOzHZIRGbukKnhjx12Ed_EBUbF6cb_XFF6bs/exec';

// å¡ç‰‡å†…å®¹å’Œiframeæ•°æ®
const cardContents = [
    { // Received From
        title: "Received From ä»å“ªæ”¶åˆ°",
        frames: [
            {
                title: "Received From ä»å“ªæ”¶åˆ°",
                options: [
                    {id: "rf1-1", en: "Received 3D Drawing (Completely Stamped)", cn: "æ”¶åˆ°å®Œæ•´ç›–ç« çš„ç«‹ä½“å›¾"},
                    {id: "rf1-2", en: "Received Checked 3D Drawing from Supervisor", cn: "ä»å¤´æ‰‹é‚£æ”¶åˆ°å·²æ£€æŸ¥çš„ç«‹ä½“å›¾"},
                    {id: "rf1-3", en: "Received 2D Drawing from Drawing Department", cn: "ä»ç»˜å›¾éƒ¨æ”¶åˆ°å±•å¼€å›¾"},
                    {id: "rf1-4", en: "Received Checked 2D Drawing from Supervisor", cn: "ä»å¤´æ‰‹é‚£æ”¶åˆ°å·²æ£€æŸ¥çš„å±•å¼€å›¾"},
                    {id: "rf1-5", en: "Received Stamped 2D Drawing from Document Control", cn: "ä»æ–‡ä»¶ç®¡ç†éƒ¨æ”¶åˆ°å·²ç›–ç« çš„å±•å¼€å›¾"},
                    {id: "rf1-6", en: "Received from Laser Cutting", cn: "ä»æ¿€å…‰åˆ‡å‰²éƒ¨æ”¶åˆ°"},
                    {id: "rf1-7", en: "Received from V Cut", cn: "ä»Væ§½åˆ‡å‰²æœºæ”¶åˆ°"},
                    {id: "rf1-8", en: "Received from Bending", cn: "ä»å‡¹æ¿éƒ¨æ”¶åˆ°"},
                    {id: "rf1-9", en: "Received from Cutting", cn: "ä»åˆ‡å‰²éƒ¨æ”¶åˆ°"},
                    {id: "rf1-10", en: "Received from Welding & Assembly", cn: "ä»ç„Šæ¥ä¸ç»„è£…éƒ¨æ”¶åˆ°"},
                    {id: "rf1-11", en: "Received from Polishing", cn: "ä»æŠ›å…‰éƒ¨æ”¶åˆ°"},
                    {id: "rf1-12", en: "Received from Acid Wash", cn: "ä»åŒ–å­¦æ¸…æ´—éƒ¨æ”¶åˆ°"},
                    {id: "rf1-13", en: "Received from Electrical Work", cn: "ä»ç”µå·¥éƒ¨æ”¶åˆ°"},
                    {id: "rf1-14", en: "Received from Gas Fitting", cn: "ä»æ¥æ°”ç®¡éƒ¨æ”¶åˆ°"},
                    {id: "rf1-15", en: "Received from Plumbing Job", cn: "ä»æ¥æ°´ç®¡éƒ¨æ”¶åˆ°"},
                    {id: "rf1-16", en: "Received from Quality Control", cn: "ä»è´¨æ£€éƒ¨æ”¶åˆ°"},
                    {id: "rf1-17", en: "Received from Packaging", cn: "ä»åŒ…è£…éƒ¨æ”¶åˆ°"},
                    {id: "rf1-18", en: "Received from Finished Goods Labeling", cn: "ä»æˆå“æ ‡ç­¾éƒ¨æ”¶åˆ°"},
                    {id: "rf1-19", en: "Received Order from Marketing Department to Deliver Product to Sub-Contractor", cn: "ä»æˆå“æ ‡ç­¾éƒ¨æ”¶åˆ°"},
                    {id: "rf1-20", en: "Received Order from Marketing Department to Bring Back Processed Product", cn: "ä»å¸‚åœºéƒ¨æ”¶åˆ°æŒ‡ä»¤æŠŠä»£å·¥/åˆ†åŒ…å•†å¤„ç†å¥½çš„äº§å“æ‹¿å›æ¥"},
                    {id: "rf1-21", en: "Received Product from Sub Contractor", cn: "ä»ä»£å·¥/åˆ†åŒ…å•†æ”¶åˆ°äº§å“"}
                ]
            },
            {
                title: "Check æ£€æŸ¥",
                options: [
                    {id: "rf2-1", en: "Pass", cn: "è¿‡å…³"},
                    {id: "rf2-2", en: "Deficiencies", cn: "ä¸è¶³ä¹‹å¤„"}
                ],
                hasInput: true
            }
        ]
    },
    { // Job Completed
        title: "Job Completed å·²å®Œæˆçš„å·¥ä½œ",
        frames: [
            {
                title: "Job Completed å·²å®Œæˆçš„å·¥ä½œ",
                options: [
                    {id: "jc1-1", en: "QR Code Creation", cn: "äºŒç»´ç åˆ›å»º"},
                    {id: "jc1-2", en: "Document Control: Checked & Stamped", cn: "æ–‡ä»¶ç®¡ç†: æ£€æŸ¥ç›–ç« "},
                    {id: "jc1-3", en: "Project Department: Explained & Passed Drawing", cn: "é¡¹ç›®éƒ¨: è®²è§£ & ä¸‹å›¾"},
                    {id: "jc1-4", en: "Supervisor: Checked 3D Drawing", cn: "å¤´æ‰‹: å®Œæˆç«‹ä½“å›¾çš„æ£€æŸ¥"},
                    {id: "jc1-5", en: "2D Drawing", cn: "å±•å¼€å›¾"},
                    {id: "jc1-6", en: "Supervisor: Checked 2D Drawing & Signed", cn: "å¤´æ‰‹: å®Œæˆå±•å¼€å›¾çš„æ£€æŸ¥å¹¶ç­¾å"},
                    {id: "jc1-7", en: "Laser Cutting", cn: "æ¿€å…‰åˆ‡å‰²"},
                    {id: "jc1-8", en: "V Cut", cn: "Væ§½åˆ‡å‰²"},
                    {id: "jc1-9", en: "Bending", cn: "å‡¹æ¿"},
                    {id: "jc1-10", en: "Cutting", cn: "åˆ‡å‰²"},
                    {id: "jc1-11", en: "Welding & Assembly", cn: "ç„Šæ¥ä¸ç»„è£…"},
                    {id: "jc1-12", en: "Painting", cn: "ä¸Šæ¼†"},
                    {id: "jc1-13", en: "Polishing", cn: "æŠ›å…‰"},
                    {id: "jc1-14", en: "Acid Wash", cn: "åŒ–å­¦æ¸…æ´—"},
                    {id: "jc1-15", en: "Electrical Work", cn: "ç”µå·¥"},
                    {id: "jc1-16", en: "Gas Fitting", cn: "æ°”ç®¡å·¥"},
                    {id: "jc1-17", en: "Plumbing Job", cn: "æ°´ç®¡å·¥"},
                    {id: "jc1-18", en: "Quality Control", cn: "è´¨æ£€"},
                    {id: "jc1-19", en: "Packaging", cn: "åŒ…è£…"},
                    {id: "jc1-20", en: "Finished Goods Labeling", cn: "ç»™æˆå“è´´æ ‡ç­¾"},
                    {id: "jc1-21", en: "Deliver Product to Sub-Contractor", cn: "é€äº§å“åˆ°ä»£å·¥/åˆ†åŒ…å•†"},
                    {id: "jc1-22", en: "Bring Back Processed Product from Sub-Contractor", cn: "ä»ä»£å·¥/åˆ†åŒ…å•†æ‹¿å›å¤„ç†å¥½çš„äº§å“"},
                    {id: "jc1-23", en: "Shipping Out", cn: "å‡ºè´§"}
                ]
            },
            {
                title: "Quantity of Product Completed by You ç”±ä½ å®Œæˆçš„äº§å“æ•°é‡",
                options: []
            }
        ]
    },
    { // Quality Control
        title: "Quality Control è´¨é‡æ£€æŸ¥",
        frames: []
    }
];

// ========== è®¾å¤‡æ£€æµ‹å‡½æ•° ==========
function isMobile() {
    return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

// ========== ä¿®å¤æ»šåŠ¨ä½ç½®é—®é¢˜çš„å˜é‡ ==========
let isSwitchingCard = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨åˆ‡æ¢å¡ç‰‡ï¼ˆå†…å®¹é‡ç½®æ˜¯é¢„æœŸçš„ï¼‰

// ========== æ ¸å¿ƒä¿®å¤ï¼šcontent-frameå†…éƒ¨æ»šåŠ¨ä½ç½®ä¿æŒ ==========
// ä¿å­˜content-frameçš„æ»šåŠ¨ä½ç½®
function saveFrameScrollPosition() {
    const contentFrame = document.getElementById('contentFrame');
    if (!contentFrame) return null;
    
    return {
        scrollTop: contentFrame.scrollTop,
        clientHeight: contentFrame.clientHeight,
        scrollHeight: contentFrame.scrollHeight,
        timestamp: Date.now()
    };
}

// æ¢å¤content-frameçš„æ»šåŠ¨ä½ç½®
function restoreFrameScrollPosition(savedPosition) {
    const contentFrame = document.getElementById('contentFrame');
    if (!contentFrame || !savedPosition) return;
    
    // ç«‹å³æ¢å¤
    contentFrame.scrollTop = savedPosition.scrollTop;
    
    // åŒä¿é™©ï¼šåœ¨ä¸‹ä¸€å¸§å†æ¢å¤ä¸€æ¬¡
    requestAnimationFrame(() => {
        contentFrame.scrollTop = savedPosition.scrollTop;
    });
}

// ========== äºŒç»´ç æ‰«æåŠŸèƒ½ ==========
async function startQRScanner() {
    try {
        console.log("Starting QR scanner...");
        
        // éšè—å¼€å§‹æŒ‰é’®ï¼Œæ˜¾ç¤ºåœæ­¢å’Œåˆ‡æ¢æŒ‰é’®
        document.getElementById('startScanner').style.display = 'none';
        document.getElementById('stopScanner').style.display = 'inline-block';
        document.getElementById('switchCamera').style.display = 'inline-block';
        
        // éšè—æ‰«æè¦†ç›–å±‚
        scannerOverlay.classList.add('hidden');
        
        // æ˜¾ç¤ºæ‰«ææç¤º
        cameraInstruction.style.display = 'block';
        
        if (isMobileDevice && typeof Html5QrcodeScanner !== 'undefined') {
            // æ‰‹æœºç«¯ä½¿ç”¨html5-qrcodeåº“
            await startMobileQRScanner();
        } else {
            // ç”µè„‘ç«¯ä½¿ç”¨jsQRåº“
            await startDesktopQRScanner();
        }
    } catch (error) {
        console.error("Camera error:", error);
        alert("Unable to access camera. Please check permissions.");
        stopQRScanner();
    }
}

async function startDesktopQRScanner() {
    try {
        const constraints = {
            video: { 
                facingMode: currentFacingMode,
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };
        
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoStream = stream;
        
        scannerVideo.srcObject = stream;
        await scannerVideo.play();
        
        qrScannerActive = true;
        requestAnimationFrame(scanQRCode);
        console.log("Desktop QR scanner started successfully");
    } catch (error) {
        console.error("Camera error:", error);
        alert("Unable to access camera: " + error.message);
        stopQRScanner();
    }
}

async function startMobileQRScanner() {
    try {
        // æ¸…ç†æ—§çš„æ‰«æå™¨
        if (html5QrcodeScanner) {
            await html5QrcodeScanner.clear();
        }
        
        // åˆ›å»ºæ–°çš„æ‰«æå™¨
        html5QrcodeScanner = new Html5Qrcode("scannerContainer");
        
        await html5QrcodeScanner.start(
            { facingMode: "environment" },
            { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            },
            (decodedText) => {
                console.log("Mobile scanned successfully:", decodedText);
                processScannedQR(decodedText);
            },
            (errorMessage) => {
                // å¿½ç•¥è§£æé”™è¯¯ï¼Œç»§ç»­æ‰«æ
                console.log("Scanning...");
            }
        );
        
        console.log("Mobile scanner started successfully");
    } catch (err) {
        console.error("Mobile camera error:", err);
        alert("Camera initialization failed: " + err.message);
        stopQRScanner();
    }
}

function scanQRCode() {
    if (!qrScannerActive || !scannerContext) return;
    
    if (scannerVideo.readyState === scannerVideo.HAVE_ENOUGH_DATA) {
        scannerCanvas.width = scannerVideo.videoWidth;
        scannerCanvas.height = scannerVideo.videoHeight;
        
        scannerContext.drawImage(scannerVideo, 0, 0, scannerCanvas.width, scannerCanvas.height);
        
        try {
            const imageData = scannerContext.getImageData(0, 0, scannerCanvas.width, scannerCanvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });
            
            if (code) {
                console.log("Desktop scanned successfully:", code.data);
                processScannedQR(code.data);
                stopQRScanner();
            }
        } catch (error) {
            console.warn('Error scanning QR code:', error);
        }
    }
    
    if (qrScannerActive) {
        requestAnimationFrame(scanQRCode);
    }
}

async function stopQRScanner() {
    qrScannerActive = false;
    
    // åœæ­¢æ‰‹æœºç«¯æ‰«æå™¨
    if (html5QrcodeScanner) {
        try {
            await html5QrcodeScanner.stop();
            html5QrcodeScanner.clear();
            html5QrcodeScanner = null;
        } catch (err) {
            console.error("Error stopping mobile scanner:", err);
        }
    }
    
    // åœæ­¢è§†é¢‘æµ
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }
    
    // é‡ç½®è§†é¢‘å…ƒç´ 
    if (scannerVideo) {
        scannerVideo.srcObject = null;
    }
    
    // é‡ç½®æŒ‰é’®çŠ¶æ€
    document.getElementById('startScanner').style.display = 'inline-block';
    document.getElementById('stopScanner').style.display = 'none';
    document.getElementById('switchCamera').style.display = 'none';
    
    // æ˜¾ç¤ºæ‰«æè¦†ç›–å±‚
    scannerOverlay.classList.remove('hidden');
    
    // éšè—æ‰«ææç¤º
    cameraInstruction.style.display = 'none';
    
    console.log("QR scanner stopped");
}

function switchCamera() {
    currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
    stopQRScanner();
    
    // å»¶è¿Ÿåé‡æ–°å¯åŠ¨ç›¸æœº
    setTimeout(() => {
        startQRScanner();
    }, 500);
}

// ========== QRç å¤„ç†é€»è¾‘ ==========
function processScannedQR(qrData) {
    console.log("Processing QR data:", qrData);
    
    try {
        // å»é™¤å‰åç©ºæ ¼
        qrData = qrData.trim();
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯URLæ ¼å¼
        if (qrData.startsWith('http')) {
            // å°è¯•ä»URLä¸­æå–å‘˜å·¥key
            try {
                const url = new URL(qrData);
                // è·å–æœ€åä¸€ä¸ªè·¯å¾„æ®µ
                const pathParts = url.pathname.split('/').filter(p => p);
                if (pathParts.length > 0) {
                    const employeeKey = pathParts[pathParts.length - 1];
                    validateEmployee(employeeKey);
                    return;
                }
            } catch (e) {
                console.log("Not a valid URL, trying direct match");
            }
        }
        
        // ç›´æ¥åŒ¹é…æ•´ä¸ªå­—ç¬¦ä¸²
        validateEmployee(qrData);
        
    } catch (error) {
        console.error("Error processing QR code:", error);
        alert(`Error processing QR code: ${error.message}\n\nPlease scan a valid employee QR code.`);
    }
}

// ========== å‘˜å·¥éªŒè¯å’Œè·³è½¬é€»è¾‘ ==========
function validateEmployee(employeeKey) {
    console.log("Validating employee key:", employeeKey);
    
    // ç›´æ¥æ£€æŸ¥å‘˜å·¥æ˜ å°„
    if (EMPLOYEE_MAP[employeeKey]) {
        const employeeName = EMPLOYEE_MAP[employeeKey];
        console.log("Employee found:", employeeName);
        
        // æ˜¾ç¤ºå‘˜å·¥æ¬¢è¿ä¿¡æ¯
        employeeNameDisplay.textContent = employeeName;
        employeeWelcome.style.display = 'block';
        
        // å»¶è¿Ÿ1ç§’åè·³è½¬åˆ°å·¥ä½œé¡µé¢
        setTimeout(() => {
            handleCredentialScan(employeeName);
        }, 1000);
    } else {
        // å°è¯•å»é™¤å¯èƒ½çš„åç¼€æˆ–å‚æ•°
        const cleanKey = employeeKey.split('?')[0].split('#')[0];
        if (EMPLOYEE_MAP[cleanKey]) {
            const employeeName = EMPLOYEE_MAP[cleanKey];
            employeeNameDisplay.textContent = employeeName;
            employeeWelcome.style.display = 'block';
            
            setTimeout(() => {
                handleCredentialScan(employeeName);
            }, 1000);
        } else {
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            alert(`Unknown employee QR code.\n\nScanned: ${employeeKey}\n\nPlease scan a valid employee QR code from the list.`);
            
            // é‡æ–°å¼€å§‹æ‰«æ
            if (isMobileDevice && html5QrcodeScanner) {
                // æ‰‹æœºç«¯ç»§ç»­æ‰«æ
                console.log("Continuing mobile scan...");
            } else {
                // ç”µè„‘ç«¯ç»§ç»­æ‰«æ
                console.log("Continuing desktop scan...");
            }
        }
    }
}

// ========== æ–°å¢å‡½æ•°ï¼šæ›´æ–°æœ€åç”¨æˆ·ä¿¡æ¯ ==========
async function updateLastUserInformation() {
    try {
        // è·å–URLå‚æ•°
        const params = getUrlParameters();
        if (!params || !params.salesOrderNo || !params.itemNo) {
            console.log('No URL parameters, cannot fetch last user data');
            return;
        }
        
        console.log('Fetching last user data...');
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('lastUserValue').textContent = 'Loading...';
        document.getElementById('lastUserStatusValue').textContent = 'Loading...';
        document.getElementById('lastUserSelectionValue').textContent = 'Loading...';
        
        // ä»GASè·å–æœ€åä¸€è¡Œæ•°æ®
        const lastUserData = await fetchLastUserData(params.salesOrderNo, params.itemNo);
        
        // æ›´æ–°ä¾§è¾¹æ æ˜¾ç¤º
        if (lastUserData.success) {
            document.getElementById('lastUserValue').textContent = lastUserData.lastUser;
            document.getElementById('lastUserStatusValue').textContent = lastUserData.lastUserStatus;
            document.getElementById('lastUserSelectionValue').textContent = lastUserData.lastUserSelection;
            console.log('Last user information updated:', lastUserData);
        } else {
            // å¦‚æœè·å–å¤±è´¥æˆ–æ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤º"-"
            document.getElementById('lastUserValue').textContent = '-';
            document.getElementById('lastUserStatusValue').textContent = '-';
            document.getElementById('lastUserSelectionValue').textContent = '-';
            console.log('No last user data found or error occurred');
        }
    } catch (error) {
        console.error('Error updating last user information:', error);
        document.getElementById('lastUserValue').textContent = '-';
        document.getElementById('lastUserStatusValue').textContent = '-';
        document.getElementById('lastUserSelectionValue').textContent = '-';
    }
}

// ========== ä¿®æ”¹handleCredentialScanå‡½æ•° ==========
function handleCredentialScan(employeeName) {
    console.log("Handling credential scan for:", employeeName);
    
    // åœæ­¢äºŒç»´ç æ‰«æ
    stopQRScanner();
    
    // éšè—å›¾çº¸ä¿¡æ¯ï¼Œæ˜¾ç¤ºå·¥ä½œæ•°æ®å½•å…¥é¡µé¢
    document.getElementById("drawingSection").style.display = "none";
    document.getElementById("workSection").style.display = "block";
    currentUser = employeeName;
    
    // ä¿®æ”¹ï¼šCurrent Useræ˜¾ç¤ºä¸ºä¸€è¡Œ
    document.getElementById("currentUserName").textContent = "Current Userï¼š" + employeeName;
    
    // æ˜¾ç¤ºå¹¶æ›´æ–°å›¾çº¸ä¿¡æ¯ä¸²è”æ¡†
    updateDrawingInfoSummary();
    drawingInfoSummary.style.display = "block";
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åº”è¯¥åœ¨Job Completedæ¨¡å¼
    if (JOB_COMPLETED_USERS_NO_QUANTITY.includes(employeeName)) {
        // ç‰¹å®šç”¨æˆ·ï¼šé»˜è®¤è¿›å…¥Job Completedæ¨¡å¼
        currentCardIndex = 1;
        console.log(`${employeeName} is in job completed users list, starting in Job Completed mode`);
    } else {
        // å…¶ä»–ç”¨æˆ·ï¼šé»˜è®¤è¿›å…¥Received Fromæ¨¡å¼
        currentCardIndex = 0;
        console.log(`${employeeName} is not in job completed users list, starting in Received From mode`);
    }
    
    // é‡ç½®æ‰€æœ‰é€‰æ‹©çŠ¶æ€
    clearAllSelections();
    
    // åˆå§‹åŒ–å¡ç‰‡
    initCards();
    renderCardContent();
    
    // æ–°å¢ï¼šç«‹å³è·å–å¹¶æ˜¾ç¤ºæœ€åç”¨æˆ·ä¿¡æ¯
    updateLastUserInformation();
}

// ========== å·¥ä½œé¡µé¢åŠŸèƒ½ ==========
function updateDrawingInfoSummary() {
    // æŒ‰ç…§è¦æ±‚çš„æ ¼å¼ï¼šSales Order No.-Customer Name-Item No.-Item Name-Dimension-Quantity-Unit of Measurement-EDD:Estimated Delivery Date
    const summaryHTML = `
        <span class="info-item">
            <span class="info-label">Sales Order No.</span>
            <span>${drawingInfo.salesOrder}</span>
        </span>
        <span class="info-separator">-</span>
        <span class="info-item">
            <span class="info-label">Customer Name</span>
            <span>${drawingInfo.customerName}</span>
        </span>
        <span class="info-separator">-</span>
        <span class="info-item">
            <span class="info-label">Item No.</span>
            <span>${drawingInfo.itemNo}</span>
        </span>
        <span class="info-separator">-</span>
        <span class="info-item">
            <span class="info-label">Item Name</span>
            <span>${drawingInfo.itemName}</span>
        </span>
        <span class="info-separator">-</span>
        <span class="info-item">
            <span class="info-label">Dimension</span>
            <span>${drawingInfo.dimension}</span>
        </span>
        <span class="info-separator">-</span>
        <span class="info-item">
            <span class="info-label">Quantity</span>
            <span>${drawingInfo.quantity}</span>
        </span>
        <span class="info-separator">-</span>
        <span class="info-item">
            <span class="info-label">Unit of Measurement</span>
            <span>${drawingInfo.unit}</span>
        </span>
        <span class="info-separator">-</span>
        <span class="info-item">
            <span class="info-label">EDD:</span>
            <span>${drawingInfo.deliveryDate}</span>
        </span>
    `;
    
    drawingInfoSummary.innerHTML = summaryHTML;
}

function initCards() {
    const cards = document.querySelectorAll('.card-box');
    
    cards.forEach(card => {
        card.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const newIndex = parseInt(this.getAttribute('data-card-index'));
            
            if (newIndex === currentCardIndex) {
                return;
            }
            
            // æ ‡è®°ä¸ºåˆ‡æ¢å¡ç‰‡
            isSwitchingCard = true;
            
            // è‡ªåŠ¨æ¸…é™¤ä¹‹å‰é¡µé¢çš„é€‰æ‹©
            clearOtherPagesSelections(newIndex);
            
            // æ›´æ–°å½“å‰å¡ç‰‡ç´¢å¼•
            currentCardIndex = newIndex;
            
            // æ›´æ–°å¡ç‰‡é€‰æ‹©çŠ¶æ€
            updateCardSelection();
            
            // æ›´æ–°å¡ç‰‡ä¸Šçš„ç”¨æˆ·é€‰æ‹©æ˜¾ç¤º
            updateCardUserSelections();
            
            // æ¸²æŸ“æ–°å¡ç‰‡å†…å®¹
            renderCardContent();
        });
    });
    
    // åˆå§‹æ›´æ–°å¡ç‰‡é€‰æ‹©çŠ¶æ€
    updateCardSelection();
    updateCardUserSelections();
}

function clearOtherPagesSelections(newPageIndex) {
    if (newPageIndex !== 0) {
        selectedOptions.receivedFrom1 = null;
        selectedOptions.receivedFrom2 = null;
    }
    
    if (newPageIndex !== 1) {
        selectedOptions.jobCompleted = null;
        jobCompletedQuantity = "";
    }
    
    if (newPageIndex !== 2) {
        // é‡ç½®QCæ•°æ®
        Object.keys(qcData).forEach(key => {
            qcData[key] = { selected: null, details: '' };
        });
        qcUnlocked = false;
    }
    
    updateCardUserSelections();
}

function updateCardSelection() {
    const cards = document.querySelectorAll('.card-box');
    
    cards.forEach((card, index) => {
        card.classList.remove('selected');
        
        if (index === currentCardIndex) {
            card.classList.add('selected');
        }
    });
}

function updateCardUserSelections() {
    // Received From
    if (selectedOptions.receivedFrom1 && selectedOptions.receivedFrom2) {
        const option1 = getOptionTextShort(selectedOptions.receivedFrom1);
        const option2 = getOptionTextShort(selectedOptions.receivedFrom2);
        document.getElementById('cardSelection0').textContent = `${option1} / ${option2}`;
    } else {
        document.getElementById('cardSelection0').textContent = '';
    }
    
    // Job Completed
    if (selectedOptions.jobCompleted) {
        const option = getOptionTextShort(selectedOptions.jobCompleted);
        document.getElementById('cardSelection1').textContent = option;
    } else {
        document.getElementById('cardSelection1').textContent = '';
    }
    
    // Quality Control
    // å¦‚æœå·²ç»å¡«å†™äº†QCæ•°æ®ï¼Œæ˜¾ç¤º"Completed"
    const qcCompleted = checkQCCompleted();
    document.getElementById('cardSelection2').textContent = qcCompleted ? 'Completed' : '';
}

function getOptionTextShort(optionId) {
    if (!optionId) return "";
    
    for (let card of cardContents) {
        for (let frame of card.frames) {
            for (let option of frame.options) {
                if (option.id === optionId) {
                    let text = option.en;
                    
                    if (text.toLowerCase().startsWith("received from ")) {
                        text = text.substring("Received from ".length);
                    } else if (text.toLowerCase().startsWith("received ")) {
                        text = text.substring("Received ".length);
                    }
                    
                    return text.length > 25 ? text.substring(0, 25) + '...' : text;
                }
            }
        }
    }
    return optionId;
}

function hasSelectionInCard(cardIndex) {
    if (cardIndex === 0) {
        // Received Froméœ€è¦ä¸¤ä¸ªé€‰é¡¹éƒ½æœ‰é€‰æ‹©
        return selectedOptions.receivedFrom1 && selectedOptions.receivedFrom2;
    } else if (cardIndex === 1) {
        // Job Completedéœ€è¦é€‰æ‹©å·¥ä½œé€‰é¡¹
        // å¯¹äºç‰¹å®šç”¨æˆ·ï¼Œåªéœ€è¦é€‰æ‹©å·¥ä½œé€‰é¡¹
        // å¯¹äºå…¶ä»–ç”¨æˆ·ï¼Œè¿˜éœ€è¦å¡«å†™æ•°é‡
        if (JOB_COMPLETED_USERS_NO_QUANTITY.includes(currentUser)) {
            return selectedOptions.jobCompleted !== null;
        } else {
            return selectedOptions.jobCompleted !== null && jobCompletedQuantity !== "";
        }
    } else if (cardIndex === 2) {
        // Quality Controléœ€è¦æ£€æŸ¥æ‰€æœ‰é—®é¢˜ï¼ˆç¬¬22é¢˜é™¤å¤–ï¼‰
        return checkQCCompleted();
    }
    return false;
}

function hasSelectionInCurrentCard() {
    return hasSelectionInCard(currentCardIndex);
}

function clearAllSelections() {
    selectedOptions = {
        receivedFrom1: null,
        receivedFrom2: null,
        jobCompleted: null,
        qualityControl: null
    };
    
    jobCompletedQuantity = "";
    
    // é‡ç½®QCæ•°æ®
    Object.keys(qcData).forEach(key => {
        qcData[key] = { selected: null, details: '' };
    });
    
    qcUnlocked = false;
    isSubmitted = false;
    
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) submitBtn.disabled = false;
    
    const successMessage = document.getElementById('successMessage');
    if (successMessage) successMessage.style.display = 'none';
    
    updateCardUserSelections();
}

// ========== ä¿®æ”¹renderCardContentå‡½æ•° ==========
function renderCardContent() {
    const contentFrame = document.getElementById('contentFrame');
    const currentCard = cardContents[currentCardIndex];
    
    // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®ï¼ˆå¦‚æœæ˜¯åˆ‡æ¢å¡ç‰‡ï¼Œå…è®¸é‡ç½®ï¼‰
    let savedScroll = null;
    if (!isSwitchingCard && contentFrame) {
        savedScroll = saveFrameScrollPosition();
    }
    
    let contentHTML = `<div class="frame-title">${currentCard.title}</div>`;
    
    if (currentCardIndex === 0) {
        contentHTML += `
            <div style="margin-bottom: 20px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #333;">${currentCard.frames[0].title}:</div>
                ${renderOptions(currentCard.frames[0].options, 'receivedFrom1')}
            </div>
            <div style="margin-bottom: 20px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #333;">${currentCard.frames[1].title}:</div>
                ${renderOptions(currentCard.frames[1].options, 'receivedFrom2')}
                ${currentCard.frames[1].hasInput ? `
                    <div id="deficiencyInput" style="margin-top: 12px; display: none;">
                        <div style="margin-bottom: 6px; font-weight: 500; color: #555;">Deficiency Details (ä¸è¶³ä¹‹å¤„è¯¦æƒ…):</div>
                        <input type="text" id="deficiencyText" class="clickable-input" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="Enter deficiency details here...">
                    </div>
                ` : ''}
            </div>
        `;
    } else if (currentCardIndex === 1) {
        // Job Completedé¡µé¢
        contentHTML += `
            <div style="margin-bottom: 20px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #333;">${currentCard.frames[0].title}:</div>
                ${renderOptions(currentCard.frames[0].options, 'jobCompleted')}
            </div>
        `;
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦éœ€è¦å¡«å†™æ•°é‡é—®é¢˜
        if (!JOB_COMPLETED_USERS_NO_QUANTITY.includes(currentUser)) {
            contentHTML += `
                <div class="quantity-section">
                    <div style="font-weight: 600; margin-bottom: 12px; color: #333; text-align: center; font-size: 16px;">
                        Quantity of Product Completed by You - ç”±ä½ å®Œæˆçš„äº§å“æ•°é‡ï¼š
                    </div>
                    <div class="quantity-input-container">
                        <label for="jobCompletedQuantity">Enter quantity (numbers only):</label>
                        <input type="text" id="jobCompletedQuantity" class="clickable-input" 
                               placeholder="Enter quantity here..." 
                               value="${jobCompletedQuantity}"
                               oninput="handleQuantityInput(this)">
                    </div>
                </div>
            `;
        }
    } else if (currentCardIndex === 2) {
        if (!qcUnlocked) {
            contentHTML += `
                <div style="text-align: center; padding: 30px 15px;">
                    <div style="font-size: 16px; color: #666; margin-bottom: 15px;">Quality Control section is locked</div>
                    <div class="password-section">
                        <div style="margin-bottom: 8px; color: #555;">Enter password to unlock:</div>
                        <div class="password-input">
                            <input type="password" id="qcPassword" placeholder="Enter password..." class="clickable-input">
                            <button onclick="checkQCPassword()">Unlock</button>
                        </div>
                        <div id="passwordError" style="color: #e74c3c; margin-top: 8px; display: none;">Incorrect password. Try again.</div>
                    </div>
                </div>
            `;
        } else {
            // æ¸²æŸ“22ä¸ªè´¨é‡æ£€æŸ¥é—®é¢˜
            contentHTML += renderQCQuestions();
        }
    }
    
    contentFrame.innerHTML = contentHTML;
    
    if (currentCardIndex === 2 && qcUnlocked) {
        // æ·»åŠ QCé—®é¢˜çš„äº‹ä»¶ç›‘å¬
        addQCOptionListeners();
        // æ¢å¤å·²é€‰æ‹©çš„é€‰é¡¹
        restoreQCOptions();
    } else {
        addOptionListeners();
        restoreSelectedOptions();
    }
    
    // æ·»åŠ Job Completedæ•°é‡è¾“å…¥æ¡†çš„äº‹ä»¶ç›‘å¬
    if (currentCardIndex === 1 && !JOB_COMPLETED_USERS_NO_QUANTITY.includes(currentUser)) {
        const quantityInput = document.getElementById('jobCompletedQuantity');
        if (quantityInput) {
            // ç¡®ä¿è¾“å…¥æ¡†å¯ä»¥è·å¾—ç„¦ç‚¹
            quantityInput.addEventListener('click', function(e) {
                e.stopPropagation();
                this.focus();
            });
            
            quantityInput.addEventListener('focus', function(e) {
                e.stopPropagation();
            });
            
            quantityInput.addEventListener('mousedown', function(e) {
                e.stopPropagation();
            });
            
            // æ¢å¤ä¹‹å‰è¾“å…¥çš„å€¼
            if (jobCompletedQuantity) {
                quantityInput.value = jobCompletedQuantity;
            }
        }
    }
    
    updateSubmitButton();
    
    // æ¢å¤æ»šåŠ¨ä½ç½®ï¼ˆå¦‚æœä¸æ˜¯åˆ‡æ¢å¡ç‰‡ï¼‰
    if (!isSwitchingCard && savedScroll) {
        restoreFrameScrollPosition(savedScroll);
    }
    
    isSwitchingCard = false;
}

// ========== æ¸²æŸ“QCé—®é¢˜çš„å‡½æ•° ==========
function renderQCQuestions() {
    let html = '<div style="max-width: 100%; overflow-x: hidden;">';
    
    QC_QUESTIONS.forEach((question, index) => {
        const questionNumber = index + 1;
        const qcDataItem = qcData[question.id];
        
        html += `
            <div class="qc-question" id="${question.id}_container">
                <div class="question-text">
                    <span class="question-number">${questionNumber}.</span>
                    ${question.en}
                </div>
                <div class="question-chinese">${question.cn}</div>
        `;
        
        if (question.options && question.options.length > 0) {
            html += `
                <div class="qc-options" id="${question.id}_options">
            `;
            
            question.options.forEach((option, optIndex) => {
                const isSelected = qcDataItem.selected === option.en;
                html += `
                    <div class="qc-option-item ${isSelected ? 'selected' : ''}" 
                         data-question="${question.id}" 
                         data-option="${option.en}">
                        <div class="qc-radio ${isSelected ? 'selected' : ''}"></div>
                        <div class="qc-option-text">
                            ${option.en} ${option.cn ? `(${option.cn})` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
        }
        
        // æ·»åŠ Detailsæ–‡æœ¬æ¡†ï¼ˆæ‰€æœ‰é—®é¢˜éƒ½æœ‰ï¼‰
        html += `
            <div class="qc-details">
                <div class="details-label">Detailsï¼š</div>
                <input type="text" 
                       class="details-input" 
                       id="${question.id}_details" 
                       placeholder="Enter details here..."
                       value="${qcDataItem.details || ''}"
                       oninput="updateQCDetails('${question.id}', this.value)">
            </div>
        `;
        
        // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
        html += `
            <div class="error-message" id="${question.id}_error">
                Please select an option for this question
            </div>
        `;
        
        html += `</div>`; // å…³é—­qc-question div
    });
    
    html += '</div>';
    return html;
}

// ========== QCé€‰é¡¹ç›‘å¬å™¨ ==========
function addQCOptionListeners() {
    const optionItems = document.querySelectorAll('.qc-option-item');
    
    optionItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.stopPropagation();
            
            const questionId = this.getAttribute('data-question');
            const optionValue = this.getAttribute('data-option');
            
            // ä¿å­˜æ»šåŠ¨ä½ç½®
            const savedScroll = saveFrameScrollPosition();
            
            // æ›´æ–°æ•°æ®
            qcData[questionId].selected = optionValue;
            
            // æ›´æ–°UI
            updateQCOptionStyles(questionId, optionValue);
            
            // æ¸…é™¤é”™è¯¯çŠ¶æ€
            clearQCError(questionId);
            
            // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
            updateSubmitButton();
            updateCardUserSelections();
            
            // æ¢å¤æ»šåŠ¨ä½ç½®
            restoreFrameScrollPosition(savedScroll);
        });
    });
}

function updateQCOptionStyles(questionId, selectedOption) {
    const container = document.getElementById(`${questionId}_options`);
    if (!container) return;
    
    const options = container.querySelectorAll('.qc-option-item');
    
    options.forEach(option => {
        const optionValue = option.getAttribute('data-option');
        const radio = option.querySelector('.qc-radio');
        
        if (optionValue === selectedOption) {
            option.classList.add('selected');
            if (radio) radio.classList.add('selected');
        } else {
            option.classList.remove('selected');
            if (radio) radio.classList.remove('selected');
        }
    });
}

function updateQCDetails(questionId, value) {
    qcData[questionId].details = value;
}

function restoreQCOptions() {
    Object.keys(qcData).forEach(questionId => {
        const selectedOption = qcData[questionId].selected;
        if (selectedOption) {
            updateQCOptionStyles(questionId, selectedOption);
        }
        
        // æ¢å¤detailså€¼
        const detailsInput = document.getElementById(`${questionId}_details`);
        if (detailsInput) {
            detailsInput.value = qcData[questionId].details || '';
        }
    });
}

// ========== ä¿®æ”¹addOptionListenerså‡½æ•° ==========
function addOptionListeners() {
    // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé˜²æ­¢é‡å¤ï¼‰
    document.removeEventListener('click', optionClickHandler);
    
    // å®šä¹‰æ–°çš„ç‚¹å‡»å¤„ç†å™¨
    function optionClickHandler(e) {
        let optionItem = e.target.closest('.option-item');
        if (!optionItem && e.target.classList.contains('custom-radio')) {
            optionItem = e.target.closest('.option-item');
        }
        
        if (optionItem) {
            // é˜»æ­¢æ‰€æœ‰é»˜è®¤è¡Œä¸º
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            // ä¿å­˜content-frameçš„æ»šåŠ¨ä½ç½®
            const savedScroll = saveFrameScrollPosition();
            
            const optionId = optionItem.getAttribute('data-id');
            const category = optionItem.getAttribute('data-category');
            
            // æ›´æ–°é€‰æ‹©
            selectedOptions[category] = optionId;
            
            // åªæ›´æ–°æ ·å¼ï¼Œä¸é‡æ–°æ¸²æŸ“
            updateOptionStyles(category, optionId);
            
            // å¤„ç†ç‰¹æ®Šæƒ…å†µï¼ˆæ˜¾ç¤ºè¾“å…¥æ¡†ï¼‰
            if (optionId === 'rf2-2') {
                const deficiencyInput = document.getElementById('deficiencyInput');
                if (deficiencyInput) {
                    deficiencyInput.style.display = 'block';
                    setTimeout(() => {
                        const deficiencyText = document.getElementById('deficiencyText');
                        if (deficiencyText) {
                            deficiencyText.focus();
                            // æ¢å¤æ»šåŠ¨ä½ç½®
                            restoreFrameScrollPosition(savedScroll);
                        }
                    }, 50);
                }
            } else if (category === 'receivedFrom2') {
                const deficiencyInput = document.getElementById('deficiencyInput');
                if (deficiencyInput) deficiencyInput.style.display = 'none';
            }
            
            updateCardUserSelections();
            updateSubmitButton();
            
            // æ¢å¤æ»šåŠ¨ä½ç½®
            restoreFrameScrollPosition(savedScroll);
            
            return false;
        }
    }
    
    // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œç¡®ä¿æœ€æ—©æ‰§è¡Œ
    document.addEventListener('click', optionClickHandler, true);
}

// ========== ä¿®æ”¹updateOptionStyleså‡½æ•° ==========
function updateOptionStyles(category, selectedId) {
    // è¿™ä¸ªæ–¹æ³•åªæ›´æ–°æ ·å¼ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªcontent-frame
    // æ‰€ä»¥ä¸ä¼šå¯¼è‡´æ»šåŠ¨ä½ç½®é‡ç½®
    
    const options = document.querySelectorAll(`.option-item[data-category="${category}"]`);
    
    for (let i = 0; i < options.length; i++) {
        const item = options[i];
        const radio = item.querySelector('.custom-radio');
        const isSelected = item.getAttribute('data-id') === selectedId;
        
        // åªæ›´æ–°ç±»åï¼Œä¸æ”¹å˜DOMç»“æ„
        if (isSelected) {
            if (!item.classList.contains('selected')) {
                item.classList.add('selected');
            }
            if (radio && !radio.classList.contains('selected')) {
                radio.classList.add('selected');
            }
        } else {
            if (item.classList.contains('selected')) {
                item.classList.remove('selected');
            }
            if (radio && radio.classList.contains('selected')) {
                radio.classList.remove('selected');
            }
        }
    }
}

// ========== æ£€æŸ¥QCæ˜¯å¦å®Œæˆ ==========
function checkQCCompleted() {
    // æ£€æŸ¥å‰21ä¸ªé—®é¢˜æ˜¯å¦å·²é€‰æ‹©ï¼ˆç¬¬22é¢˜ä¸éœ€è¦é€‰æ‹©ï¼‰
    for (let i = 0; i < 21; i++) {
        const questionId = `qc${i + 1}`;
        if (!qcData[questionId] || !qcData[questionId].selected) {
            return false;
        }
    }
    return true;
}

// ========== éªŒè¯QCæ•°æ® ==========
function validateQCData() {
    let isValid = true;
    
    // éªŒè¯å‰21ä¸ªé—®é¢˜
    for (let i = 0; i < 21; i++) {
        const questionId = `qc${i + 1}`;
        const container = document.getElementById(`${questionId}_container`);
        const errorElement = document.getElementById(`${questionId}_error`);
        
        if (!qcData[questionId] || !qcData[questionId].selected) {
            // æ ‡è®°é”™è¯¯
            if (container) container.classList.add('error-highlight');
            if (errorElement) errorElement.style.display = 'block';
            isValid = false;
        } else {
            // æ¸…é™¤é”™è¯¯æ ‡è®°
            if (container) container.classList.remove('error-highlight');
            if (errorElement) errorElement.style.display = 'none';
        }
    }
    
    return isValid;
}

function clearQCError(questionId) {
    const container = document.getElementById(`${questionId}_container`);
    const errorElement = document.getElementById(`${questionId}_error`);
    
    if (container) container.classList.remove('error-highlight');
    if (errorElement) errorElement.style.display = 'none';
}

// ========== ä¿®æ”¹handleQuantityInputå‡½æ•° ==========
function handleQuantityInput(input) {
    // ä¿å­˜æ»šåŠ¨ä½ç½®
    const savedScroll = saveFrameScrollPosition();
    
    input.value = input.value.replace(/[^0-9]/g, '');
    jobCompletedQuantity = input.value;
    updateSubmitButton();
    
    // æ¢å¤æ»šåŠ¨ä½ç½®
    restoreFrameScrollPosition(savedScroll);
}

// ========== ä¿®æ”¹checkQCPasswordå‡½æ•° ==========
function checkQCPassword() {
    const passwordInput = document.getElementById('qcPassword');
    const passwordError = document.getElementById('passwordError');
    
    // ä¿å­˜æ»šåŠ¨ä½ç½®
    const savedScroll = saveFrameScrollPosition();
    
    if (passwordInput && passwordInput.value === '1234') {
        qcUnlocked = true;
        isSwitchingCard = true; // æ ‡è®°ä¸ºåˆ‡æ¢å†…å®¹
        renderCardContent();
    } else {
        if (passwordError) passwordError.style.display = 'block';
        if (passwordInput) passwordInput.value = '';
        // æ¢å¤æ»šåŠ¨ä½ç½®
        restoreFrameScrollPosition(savedScroll);
    }
}

function renderOptions(options, category) {
    let html = '';
    options.forEach(option => {
        const isSelected = selectedOptions[category] === option.id;
        html += `
            <div class="option-item ${isSelected ? 'selected' : ''}" data-id="${option.id}" data-category="${category}">
                <div class="custom-radio ${isSelected ? 'selected' : ''}" data-for="${option.id}"></div>
                <div class="option-label">
                    <div class="option-english">${option.en}</div>
                    <div class="option-chinese">${option.cn}</div>
                </div>
            </div>
        `;
    });
    return html;
}

function restoreSelectedOptions() {
    Object.keys(selectedOptions).forEach(category => {
        const optionId = selectedOptions[category];
        if (optionId) {
            updateOptionStyles(category, optionId);
            
            if (optionId === 'rf2-2') {
                const deficiencyInput = document.getElementById('deficiencyInput');
                if (deficiencyInput) deficiencyInput.style.display = 'block';
            }
        }
    });
}

function updateSubmitButton() {
    const submitBtn = document.getElementById('submitBtn');
    const hasSelection = hasSelectionInCurrentCard();
    submitBtn.disabled = !hasSelection || isSubmitted;
}

function getOptionText(optionId) {
    if (!optionId) return "Not selected";
    
    for (let card of cardContents) {
        for (let frame of card.frames) {
            for (let option of frame.options) {
                if (option.id === optionId) {
                    return `${option.en} (${option.cn})`;
                }
            }
        }
    }
    return optionId;
}

function getPageName(cardIndex) {
    switch(cardIndex) {
        case 0: return "Received From";
        case 1: return "Job Completed";
        case 2: return "Quality Control";
        default: return "Unknown";
    }
}

// ========== æ–°å¢ï¼šç´§å‡‘çš„QCç­”æ¡ˆæ‘˜è¦å‡½æ•° ==========
function getQCAnswersSummary() {
    let summary = '';
    
    for (let i = 0; i < 22; i++) {
        const questionId = `qc${i + 1}`;
        const answer = qcData[questionId];
        
        if (answer && answer.selected) {
            summary += `<div class="qc-summary-row">
                <div class="qc-summary-number">${i + 1}.</div>
                <div class="qc-summary-answer">
                    ${answer.selected}
                    ${answer.details ? `<div class="qc-summary-details">${answer.details}</div>` : ''}
                </div>
            </div>`;
        }
    }
    
    return summary;
}

// ========== ä¿®æ”¹confirmSubmitå‡½æ•° ==========
function confirmSubmit() {
    // éšè—ç¡®è®¤æ¨¡æ€æ¡†
    document.getElementById('confirmationModal').style.display = 'none';
    
    // å¦‚æœæ˜¯Quality Controlï¼Œéœ€è¦éªŒè¯æ•°æ®
    if (currentCardIndex === 2) {
        if (!validateQCData()) {
            alert("Please complete all required questions (1-21) before submitting.");
            return;
        }
    }
    
    // å‡†å¤‡æäº¤æ•°æ®
    const submissionData = {
        timestamp: new Date().toISOString(),
        name: currentUser,
        action: "",
        spreadsheetId: targetSpreadsheetInfo.spreadsheetId,
        sheetName: targetSpreadsheetInfo.sheetName,
        salesOrderNo: drawingInfo.salesOrder,
        itemNo: drawingInfo.itemNo,
        customerName: drawingInfo.customerName,
        itemNameMain: drawingInfo.itemName.split(' ')[0] || '',
        itemNameSub: drawingInfo.itemName.split(' ').slice(1).join(' ') || '',
        dimension: drawingInfo.dimension,
        quantity: drawingInfo.quantity,
        // QCæ•°æ®
        qcData: {}
    };
    
    // æ ¹æ®å½“å‰å¡ç‰‡è®¾ç½®æ•°æ®
    if (currentCardIndex === 0) {
        // Received From
        submissionData.action = "Received from ä»å“ªæ”¶åˆ°";
        submissionData.received = getOptionText(selectedOptions.receivedFrom1);
        submissionData.check = getOptionText(selectedOptions.receivedFrom2);
        
        // å¦‚æœæœ‰ä¸è¶³ä¹‹å¤„è¯¦æƒ…ï¼Œæ·»åŠ åˆ°checkå­—æ®µ
        if (selectedOptions.receivedFrom2 === 'rf2-2') {
            const deficiencyText = document.getElementById('deficiencyText');
            if (deficiencyText && deficiencyText.value) {
                submissionData.check += " - " + deficiencyText.value;
            }
        }
    } else if (currentCardIndex === 1) {
        // Job Completed
        submissionData.action = "Job Completed å·²å®Œæˆçš„å·¥ä½œ";
        submissionData.jobCompleted = getOptionText(selectedOptions.jobCompleted);
        submissionData.quantity = jobCompletedQuantity || "";
    } else if (currentCardIndex === 2) {
        // Quality Control
        submissionData.action = "Quality Control è´¨é‡æ£€æŸ¥";
        
        // æ·»åŠ QCæ•°æ®
        Object.keys(qcData).forEach(key => {
            submissionData.qcData[key] = {
                selected: qcData[key].selected || '',
                details: qcData[key].details || ''
            };
        });
    }
    
    console.log('Submitting data:', submissionData);
    
    // æäº¤æ•°æ®åˆ°Google Sheets
    submitDataToGoogleSheets(submissionData);
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    const successMessage = document.getElementById('successMessage');
    const submitBtn = document.getElementById('submitBtn');
    
    successMessage.style.display = 'block';
    submitBtn.disabled = true;
    isSubmitted = true;
    
    // è®°å½•æäº¤çš„æ•°æ®
    console.log('Data submitted:', submissionData);
    
    // æ–°å¢ï¼šæäº¤æˆåŠŸåæ›´æ–°æœ€åç”¨æˆ·ä¿¡æ¯
    setTimeout(() => {
        updateLastUserInformation();
    }, 2000);
}

// ========== ä¿®æ”¹showConfirmationModalå‡½æ•° ==========
function showConfirmationModal() {
    if (isSubmitted) return;
    
    const hasSelection = hasSelectionInCurrentCard();
    if (!hasSelection) {
        // å¦‚æœæ˜¯Quality Controlï¼Œæ˜¾ç¤ºå…·ä½“çš„é”™è¯¯ä¿¡æ¯
        if (currentCardIndex === 2) {
            validateQCData();
            alert("Please complete all required questions (1-21) before submitting.");
        } else {
            alert("Please make a selection before submitting.");
        }
        return;
    }
    
    let confirmationMessage = `<p><strong>Drawing Info:</strong> ${drawingInfoSummary.textContent}</p>`;
    confirmationMessage += `<p><strong>Current User:</strong> ${currentUser}</p>`;
    confirmationMessage += `<p><strong>Current Page:</strong> ${getPageName(currentCardIndex)}</p>`;
    confirmationMessage += `<hr style="margin: 12px 0; border: 0; border-top: 1px solid #ddd;">`;
    
    if (currentCardIndex === 0) {
        const option1 = getOptionText(selectedOptions.receivedFrom1);
        const option2 = getOptionText(selectedOptions.receivedFrom2);
        confirmationMessage += `<p><strong>1. Received From:</strong> ${option1}</p>`;
        confirmationMessage += `<p><strong>2. Check:</strong> ${option2}</p>`;
        
        if (selectedOptions.receivedFrom2 === 'rf2-2') {
            const deficiencyText = document.getElementById('deficiencyText');
            if (deficiencyText && deficiencyText.value) {
                confirmationMessage += `<p><strong>Deficiency Details:</strong> ${deficiencyText.value}</p>`;
            }
        }
    } else if (currentCardIndex === 1) {
        const option = getOptionText(selectedOptions.jobCompleted);
        confirmationMessage += `<p><strong>Selected:</strong> ${option}</p>`;
        
        // æ·»åŠ æ•°é‡ä¿¡æ¯ï¼ˆå¦‚æœç”¨æˆ·éœ€è¦å¡«å†™ï¼‰
        if (!JOB_COMPLETED_USERS_NO_QUANTITY.includes(currentUser) && jobCompletedQuantity) {
            confirmationMessage += `<p><strong>Quantity of Product Completed by You:</strong> ${jobCompletedQuantity}</p>`;
        }
    } else if (currentCardIndex === 2) {
        // ä½¿ç”¨ç´§å‡‘çš„QCç­”æ¡ˆæ‘˜è¦
        confirmationMessage += `<p><strong>Quality Control Answers:</strong></p>`;
        confirmationMessage += `<div class="qc-summary-compact">${getQCAnswersSummary()}</div>`;
    }
    
    confirmationMessage += `<hr style="margin: 12px 0; border: 0; border-top: 1px solid #ddd;">`;
    confirmationMessage += `<p style="text-align: center; font-weight: bold;">Is this information correct?</p>`;
    
    document.getElementById('modalMessage').innerHTML = confirmationMessage;
    document.getElementById('confirmationModal').style.display = 'flex';
}

function cancelSubmit() {
    document.getElementById('confirmationModal').style.display = 'none';
}

function submitData() {
    showConfirmationModal();
}

// ========== æ–°å¢ï¼šiframeåŠ è½½å®Œæˆçš„å›è°ƒå‡½æ•° ==========
function onFormSubmitComplete() {
    console.log('Form submission complete');
    // è¿™é‡Œå¯ä»¥æ·»åŠ æäº¤å®Œæˆåçš„é¢å¤–å¤„ç†
}

// ========== ä¿®æ”¹ï¼šæäº¤æ•°æ®åˆ°Google Sheets ==========
function submitDataToGoogleSheets(submissionData) {
    // å‡†å¤‡è¡¨å•æ•°æ®
    document.getElementById('form_timestamp').value = submissionData.timestamp;
    document.getElementById('form_name').value = submissionData.name;
    document.getElementById('form_action').value = submissionData.action;
    document.getElementById('form_spreadsheetId').value = submissionData.spreadsheetId;
    document.getElementById('form_sheetName').value = submissionData.sheetName;
    document.getElementById('form_salesOrderNo').value = submissionData.salesOrderNo;
    document.getElementById('form_itemNo').value = submissionData.itemNo;
    
    // å¦‚æœæ˜¯Quality Controlï¼Œè®¾ç½®QCæ•°æ®
    if (currentCardIndex === 2) {
        // è®¾ç½®22ä¸ªQCé—®é¢˜çš„å€¼
        Object.keys(qcData).forEach((key, index) => {
            const qcIndex = index + 1;
            const formQc = document.getElementById(`form_qc${qcIndex}`);
            const formQcDetails = document.getElementById(`form_qc${qcIndex}_details`);
            
            if (formQc) formQc.value = qcData[key].selected || '';
            if (formQcDetails) formQcDetails.value = qcData[key].details || '';
        });
    }
    
    // è®¾ç½®è¡¨å•actionåˆ°GAS Web App
    document.getElementById('dataForm').action = GAS_QC_SUBMIT_URL;
    
    // æ·»åŠ iframeåŠ è½½å®Œæˆçš„ç›‘å¬å™¨
    const iframe = document.getElementById('hiddenIframe');
    iframe.onload = function() {
        onFormSubmitComplete();
    };
    
    // æäº¤è¡¨å•
    document.getElementById('dataForm').submit();
}

// ========== ä¸»åˆå§‹åŒ–å‡½æ•° ==========
async function init() {
    try {
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        document.getElementById('loadingContainer').style.display = 'block';
        
        // è·å–å¹¶è§£ç URLå‚æ•°
        const params = getUrlParameters();
        
        // éšè—é”™è¯¯ä¿¡æ¯
        hideError();
        
        if (!params) {
            // å¦‚æœæ²¡æœ‰querystringæˆ–æ— æ³•è§£æï¼Œæ˜¾ç¤º"-"
            console.log('No valid URL parameters, displaying default empty data');
            displayProductData({}, true);
            
            // å¯åŠ¨å€’è®¡æ—¶æ˜¾ç¤ºè”ç³»ç®¡ç†å‘˜ä¿¡æ¯
            startCountdown('-');
            
            // éšè—åŠ è½½åŠ¨ç”»
            document.getElementById('loadingContainer').style.display = 'none';
            return;
        }
        
        // å°è¯•ä»GASè·å–æ•°æ®
        try {
            const result = await fetchProductData(params.salesOrderNo, params.itemNo);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
            if (result.error) {
                console.warn('Error from GAS:', result.error);
                // å¦‚æœGASè¿”å›é”™è¯¯ï¼Œæ˜¾ç¤º"-"
                displayProductData({}, true);
                startCountdown('-');
            } else {
                // è·å–æ•°æ®å¯¹è±¡
                const productData = result.data || result;
                
                // ä¿®å¤Item Nameæ˜¾ç¤º - ç›´æ¥æ˜¾ç¤ºåœ¨ä¸€è¡Œ
                if (productData.itemNameMain && productData.itemNameSub) {
                    productData.itemName = `${productData.itemNameMain} ${productData.itemNameSub}`;
                } else if (productData.itemNameMain) {
                    productData.itemName = productData.itemNameMain;
                } else if (productData.itemName) {
                    // å¦‚æœitemNameä¸­åŒ…å«<br>æˆ–æ¢è¡Œï¼Œæ›¿æ¢ä¸ºç©ºæ ¼
                    productData.itemName = productData.itemName.replace(/<br>/g, ' ').replace(/\n/g, ' ');
                } else {
                    productData.itemName = '-';
                }
                
                // æ·»åŠ é”€å”®è®¢å•å’Œé¡¹ç›®å·
                productData.salesOrderNo = params.salesOrderNo;
                productData.itemNo = params.itemNo;
                
                // æ˜¾ç¤ºæ•°æ®
                displayProductData(productData);
                
                // å¯åŠ¨å€’è®¡æ—¶
                startCountdown(productData.estimatedDeliveryDate);
            }
            
        } catch (error) {
            console.warn('Error fetching data, displaying empty data:', error);
            // å¦‚æœè·å–å¤±è´¥ï¼Œæ˜¾ç¤º"-"
            displayProductData({}, true);
            startCountdown('-');
        }
        
        // éšè—åŠ è½½åŠ¨ç”»
        document.getElementById('loadingContainer').style.display = 'none';
        
    } catch (error) {
        console.error('Initialization error:', error);
        showError('Error Loading Data', error.message);
    }
}

// ========== é¡µé¢åˆå§‹åŒ– ==========
document.addEventListener('DOMContentLoaded', function() {
    // æ£€æµ‹è®¾å¤‡ç±»å‹
    isMobileDevice = isMobile();
    console.log("Is mobile device?", isMobileDevice);
    
    // è·å–DOMå…ƒç´ 
    scannerContainer = document.getElementById("scannerContainer");
    scannerVideo = document.getElementById("scannerVideo");
    scannerCanvas = document.getElementById("scannerCanvas");
    scannerContext = scannerCanvas.getContext('2d', { willReadFrequently: true });
    scannerOverlay = document.getElementById("scannerOverlay");
    scannerInput = document.getElementById("scannerInput");
    drawingSection = document.getElementById("drawingSection");
    workSection = document.getElementById("workSection");
    drawingInfoSummary = document.getElementById("drawingInfoSummary");
    
    // è·å–æ‰«ææ§åˆ¶å…ƒç´ 
    cameraInstruction = document.getElementById("cameraInstruction");
    startScannerBtn = document.getElementById("startScanner");
    stopScannerBtn = document.getElementById("stopScanner");
    switchCameraBtn = document.getElementById("switchCamera");
    
    // è·å–å‘˜å·¥æ¬¢è¿å…ƒç´ 
    employeeWelcome = document.getElementById("employeeWelcome");
    employeeNameDisplay = document.getElementById("employeeNameDisplay");
    
    // ç»‘å®šæŒ‰é’®äº‹ä»¶
    document.getElementById('startScanner').addEventListener('click', startQRScanner);
    document.getElementById('stopScanner').addEventListener('click', stopQRScanner);
    document.getElementById('switchCamera').addEventListener('click', switchCamera);
    
    // ç»‘å®šæäº¤æŒ‰é’®äº‹ä»¶
    document.getElementById('submitBtn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        submitData();
    });
    
    // åˆå§‹åŒ–é¡µé¢
    init();
    
    // ========== ç”µè„‘ç«¯å¤–æ¥æ‰«ææªæ”¯æŒ ==========
    if (!isMobileDevice) {
        // ç›‘å¬å¤–æ¥æ‰«ææªè¾“å…¥
        document.addEventListener("click", () => scannerInput.focus());
        
        scannerInput.addEventListener("keydown", (e) => {
            if(e.key === "Enter") {
                const value = scannerInput.value.trim();
                scannerInput.value = "";
                
                // ç›´æ¥æ£€æŸ¥æ˜¯å¦æ˜¯å‘˜å·¥key
                if (EMPLOYEE_MAP[value]) {
                    const employeeName = EMPLOYEE_MAP[value];
                    employeeNameDisplay.textContent = employeeName;
                    employeeWelcome.style.display = 'block';
                    
                    setTimeout(() => {
                        handleCredentialScan(employeeName);
                    }, 1000);
                } else {
                    // å°è¯•å¤„ç†ä¸ºURL
                    try {
                        processScannedQR(value);
                    } catch (error) {
                        alert(`Unknown employee code: ${value}\n\nPlease scan a valid employee QR code.`);
                    }
                }
            }
        });
        
        // é¡µé¢åŠ è½½åè‡ªåŠ¨ focus è¾“å…¥æ¡†
        setTimeout(() => {
            if (scannerInput) scannerInput.focus();
        }, 500);
    }
});
</script>
</body>
</html>
